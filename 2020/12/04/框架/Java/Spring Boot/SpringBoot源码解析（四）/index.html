<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Spring Boot 源码解析（四）run()方法执行流程 - 路由器</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="路由器"><meta name="msapplication-TileImage" content="/img/avatar.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="路由器"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Spring Boot 将依赖注入到 IOC 容器的过程"><meta property="og:type" content="blog"><meta property="og:title" content="Spring Boot 源码解析（四）run()方法执行流程"><meta property="og:url" content="http://example.com/2020/12/04/%E6%A1%86%E6%9E%B6/Java/Spring%20Boot/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/"><meta property="og:site_name" content="路由器"><meta property="og:description" content="Spring Boot 将依赖注入到 IOC 容器的过程"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/images/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/image-20211206230025019.png"><meta property="og:image" content="http://example.com/images/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/image-20211206230559761.png"><meta property="og:image" content="http://example.com/images/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/image-20211206233228333-16388047522621.png"><meta property="og:image" content="http://example.com/images/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/image-20211207232406815.png"><meta property="og:image" content="http://example.com/images/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/image-20211207231809004.png"><meta property="og:image" content="http://example.com/images/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/image-20211207233212115.png"><meta property="og:image" content="http://example.com/images/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/image-20211210223233852-16391467563871.png"><meta property="og:image" content="http://example.com/images/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/image-20211210224057328.png"><meta property="article:published_time" content="2020-12-04T11:26:11.000Z"><meta property="article:modified_time" content="2022-06-27T07:38:15.000Z"><meta property="article:author" content="路由器"><meta property="article:tag" content="SpringBoot源码解析"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/../../../../images/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/image-20211206230025019.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2020/12/04/%E6%A1%86%E6%9E%B6/Java/Spring%20Boot/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/"},"headline":"Spring Boot 源码解析（四）run()方法执行流程","image":["http://example.com/images/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/image-20211206230025019.png","http://example.com/images/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/image-20211206230559761.png","http://example.com/images/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/image-20211206233228333-16388047522621.png","http://example.com/images/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/image-20211207232406815.png","http://example.com/images/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/image-20211207231809004.png","http://example.com/images/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/image-20211207233212115.png","http://example.com/images/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/image-20211210223233852-16391467563871.png","http://example.com/images/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/image-20211210224057328.png"],"datePublished":"2020-12-04T11:26:11.000Z","dateModified":"2022-06-27T07:38:15.000Z","author":{"@type":"Person","name":"路由器"},"publisher":{"@type":"Organization","name":"路由器","logo":{"@type":"ImageObject","url":"http://example.com/img/avatar.png"}},"description":"Spring Boot 将依赖注入到 IOC 容器的过程"}</script><link rel="canonical" href="http://example.com/2020/12/04/%E6%A1%86%E6%9E%B6/Java/Spring%20Boot/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/"><link rel="icon" href="/img/avatar.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }
          Array
              .from(document.querySelectorAll('.tab-content'))
              .forEach($tab => {
                  $tab.classList.add('is-hidden');
              });
          Array
              .from(document.querySelectorAll('.tabs li'))
              .forEach($tab => {
                  $tab.classList.remove('is-active');
              });
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/avatar.png" alt="路由器" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-12-04T11:26:11.000Z" title="2020/12/4 19:26:11">2020-12-04</time>发表</span><span class="level-item"><time dateTime="2022-06-27T07:38:15.000Z" title="2022/6/27 15:38:15">2022-06-27</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Java/">Java</a><span> / </span><a class="link-muted" href="/categories/Java/Spring-Boot/">Spring Boot</a></span><span class="level-item">1 小时读完 (大约9739个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">Spring Boot 源码解析（四）run()方法执行流程</h1><div class="content"><p><code>Spring Boot</code> 将依赖注入到 <code>IOC</code> 容器的过程</p>
<span id="more"></span>

<p>前一篇说到这个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext <span class="title function_">run</span><span class="params">(Class&lt;?&gt;[] primarySources, String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>(primarySources).run(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SpringApplication</code>初始化完成后执行<code>run</code>方法，进入<code>run</code>方法中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title function_">run</span><span class="params">(String... args)</span> &#123;</span><br><span class="line">    <span class="comment">//记录运行时间</span></span><br><span class="line">    <span class="type">StopWatch</span> <span class="variable">stopWatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StopWatch</span>();</span><br><span class="line">    stopWatch.start();</span><br><span class="line">    <span class="comment">//上下文对象</span></span><br><span class="line">    <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    Collection&lt;SpringBootExceptionReporter&gt; exceptionReporters = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    configureHeadlessProperty();</span><br><span class="line">    <span class="comment">//1、获取并启动监听器</span></span><br><span class="line">    <span class="type">SpringApplicationRunListeners</span> <span class="variable">listeners</span> <span class="operator">=</span> getRunListeners(args);</span><br><span class="line">    listeners.starting();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">ApplicationArguments</span> <span class="variable">applicationArguments</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultApplicationArguments</span>(args);</span><br><span class="line">        <span class="comment">//2、构造应用上下文环境</span></span><br><span class="line">        <span class="type">ConfigurableEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> prepareEnvironment(listeners, applicationArguments);</span><br><span class="line">        configureIgnoreBeanInfo(environment);</span><br><span class="line">        <span class="type">Banner</span> <span class="variable">printedBanner</span> <span class="operator">=</span> printBanner(environment);</span><br><span class="line">        <span class="comment">//3、初始化上下文</span></span><br><span class="line">        context = createApplicationContext();</span><br><span class="line">        exceptionReporters = getSpringFactoriesInstances(SpringBootExceptionReporter.class,</span><br><span class="line">                             	<span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;ConfigurableApplicationContext.class &#125;, context);</span><br><span class="line">        <span class="comment">//4、刷新应用上下文前的准备阶段</span></span><br><span class="line">        prepareContext(context, environment, listeners, applicationArguments, printedBanner);</span><br><span class="line">        <span class="comment">//5、刷新应用上下文</span></span><br><span class="line">        refreshContext(context);</span><br><span class="line">        afterRefresh(context, applicationArguments);</span><br><span class="line">        stopWatch.stop();</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.logStartupInfo) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">StartupInfoLogger</span>(<span class="built_in">this</span>.mainApplicationClass).logStarted(getApplicationLog(), stopWatch);</span><br><span class="line">        &#125;</span><br><span class="line">        listeners.started(context);</span><br><span class="line">        callRunners(context, applicationArguments);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        handleRunFailure(context, ex, exceptionReporters, listeners);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        listeners.running(context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        handleRunFailure(context, ex, exceptionReporters, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由上面可知，<code>run</code>方法中重要步骤有六步</p>
<ol>
<li>获取并启动监听器</li>
</ol>
<h2 id="获取并启动监听器"><a href="#获取并启动监听器" class="headerlink" title="获取并启动监听器"></a>获取并启动监听器</h2><p>获取并启动监听器相关代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1、获取并启动监听器</span></span><br><span class="line"><span class="type">SpringApplicationRunListeners</span> <span class="variable">listeners</span> <span class="operator">=</span> getRunListeners(args);</span><br><span class="line">listeners.starting();</span><br></pre></td></tr></table></figure>

<p>进入<code>getRunListeners</code>方法中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> SpringApplicationRunListeners <span class="title function_">getRunListeners</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    Class&lt;?&gt;[] types = <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[] &#123; SpringApplication.class, String[].class &#125;;</span><br><span class="line">    <span class="comment">//返回的是一个新建的SpringApplicationRunListeners对象</span></span><br><span class="line">    <span class="comment">//第一个参数为logger，第二个参数为getSpringFactoriesInstances方法的返回值</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SpringApplicationRunListeners</span>(</span><br><span class="line">        logger,</span><br><span class="line">        getSpringFactoriesInstances(SpringApplicationRunListener.class, types, <span class="built_in">this</span>, args)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上面调用了方法有两个，分别为<code>getSpringFactoriesInstances()</code>方法和<code>new SpringApplicationRunListeners()</code>方法，其中第一个方法是个构造方法，而第二个方法在上一篇初始化阶段就已经介绍过，就是获取<code>Initializers</code>和<code>Listeners</code>所调用的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//首先进入new SpringApplicationRunListeners()方法</span></span><br><span class="line"><span class="comment">//可以看到这个方法只是简单的将外部传递的log和listeners集合赋值给了对象的属性</span></span><br><span class="line">SpringApplicationRunListeners(Log log, Collection&lt;? <span class="keyword">extends</span> <span class="title class_">SpringApplicationRunListener</span>&gt; listeners) &#123;</span><br><span class="line">    <span class="built_in">this</span>.log = log;</span><br><span class="line">    <span class="built_in">this</span>.listeners = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(listeners);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//接着看获取listeners集合的getSpringFactoriesInstances()方法</span></span><br><span class="line"><span class="comment">//其实就是根据传入的key获取对应的spring.factories文件中的list集合</span></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; Collection&lt;T&gt; <span class="title function_">getSpringFactoriesInstances</span><span class="params">(Class&lt;T&gt; type, Class&lt;?&gt;[] parameterTypes, Object... args)</span> &#123;</span><br><span class="line">    <span class="comment">//获取当前类加载器</span></span><br><span class="line">    <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> getClassLoader();</span><br><span class="line">    <span class="comment">//在META-INF/spring.factories 的资源文件中读取key为</span></span><br><span class="line">    <span class="comment">//org.springframework.boot.SpringApplicationRunListener的value</span></span><br><span class="line">    Set&lt;String&gt; names = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(SpringFactoriesLoader.loadFactoryNames(type, classLoader));</span><br><span class="line">    <span class="comment">//获得springFactory实例</span></span><br><span class="line">    List&lt;T&gt; instances = createSpringFactoriesInstances(type, parameterTypes, classLoader, args, names);</span><br><span class="line">    <span class="comment">//排序</span></span><br><span class="line">    AnnotationAwareOrderComparator.sort(instances);</span><br><span class="line">    <span class="keyword">return</span> instances;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//spring.factories文件中对应获取的数据，只有一个</span></span><br><span class="line"># Run Listeners</span><br><span class="line">org.springframework.boot.SpringApplicationRunListener=\</span><br><span class="line">org.springframework.boot.context.event.EventPublishingRunListener</span><br></pre></td></tr></table></figure>

<p><code>EventPublishingRunListener</code>监听器是用来监听spring boot在启动过程中不同阶段的事件，并且把这些事件通知给初始化阶段获取的ApplicationListener的那11个监听器</p>
<p><code>getRunListeners(args)</code>的这部分方法执行完毕后返回的就是一个<code>SpringApplicationRunListeners</code>对象，内部包含了监听器集合，然后会调用<code>listeners.starting()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">starting</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//此方法只是将listeners对象中的监听器集合进行遍历，分别调用starting()方法</span></span><br><span class="line">    <span class="comment">//此时集合内只有一个listener</span></span><br><span class="line">    <span class="keyword">for</span> (SpringApplicationRunListener listener : <span class="built_in">this</span>.listeners) &#123;</span><br><span class="line">        listener.starting();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="构建应用上下文环境"><a href="#构建应用上下文环境" class="headerlink" title="构建应用上下文环境"></a>构建应用上下文环境</h2><p>构建应用上下文环境部分负责加载和配置系统的环境变量以yml和propertise配置文件的相关信息，后面如果想要获取配置文件和环境变量等信息就可以直接查找到，相关代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//2、构造应用上下文环境</span></span><br><span class="line"><span class="type">ConfigurableEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> prepareEnvironment(listeners, applicationArguments);</span><br><span class="line"><span class="comment">//处理需要忽略的bean</span></span><br><span class="line">configureIgnoreBeanInfo(environment);</span><br><span class="line"><span class="comment">//打印spring启动时的那个图标</span></span><br><span class="line"><span class="type">Banner</span> <span class="variable">printedBanner</span> <span class="operator">=</span> printBanner(environment);</span><br></pre></td></tr></table></figure>

<p>下面两个方法比较简单，首先来看一下<code>configureIgnoreBeanInfo</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">IGNORE_BEANINFO_PROPERTY_NAME</span> <span class="operator">=</span> <span class="string">&quot;spring.beaninfo.ignore&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">configureIgnoreBeanInfo</span><span class="params">(ConfigurableEnvironment environment)</span> &#123;</span><br><span class="line">    <span class="comment">//是否配置了spring.beaninfo.ignore</span></span><br><span class="line">    <span class="keyword">if</span> (System.getProperty(CachedIntrospectionResults.IGNORE_BEANINFO_PROPERTY_NAME) == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//根据配置的spring.beaninfo.ignore的配置来判断是否忽略，后面会用来忽略一些bean</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">ignore</span> <span class="operator">=</span> environment.getProperty(<span class="string">&quot;spring.beaninfo.ignore&quot;</span>, Boolean.class, Boolean.TRUE);</span><br><span class="line">        System.setProperty(CachedIntrospectionResults.IGNORE_BEANINFO_PROPERTY_NAME, ignore.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入<code>prepareEnvironment</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ConfigurableEnvironment <span class="title function_">prepareEnvironment</span><span class="params">(SpringApplicationRunListeners listeners,</span></span><br><span class="line"><span class="params">			ApplicationArguments applicationArguments)</span> &#123;</span><br><span class="line">    <span class="comment">//（1）创建和配置环境变量</span></span><br><span class="line">    <span class="comment">//创建环境</span></span><br><span class="line">    <span class="type">ConfigurableEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> getOrCreateEnvironment();</span><br><span class="line">    <span class="comment">//配置环境信息</span></span><br><span class="line">    configureEnvironment(environment, applicationArguments.getSourceArgs());</span><br><span class="line">    <span class="comment">//添加新建的一个name为configurationProperties的source</span></span><br><span class="line">    ConfigurationPropertySources.attach(environment);</span><br><span class="line">    <span class="comment">//（2）启动响应监听器</span></span><br><span class="line">    listeners.environmentPrepared(environment);</span><br><span class="line">    <span class="comment">//将environment绑定到SpringApplication上</span></span><br><span class="line">    <span class="comment">//里面只有一行代码：Binder.get(environment).bind(&quot;spring.main&quot;, Bindable.ofInstance(this));</span></span><br><span class="line">    bindToSpringApplication(environment);</span><br><span class="line">    <span class="comment">//是自定义环境</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.isCustomEnvironment) &#123;</span><br><span class="line">        <span class="comment">//添加环境转换器</span></span><br><span class="line">        environment = <span class="keyword">new</span> <span class="title class_">EnvironmentConverter</span>(getClassLoader()).convertEnvironmentIfNecessary(</span><br><span class="line">            environment,</span><br><span class="line">            deduceEnvironmentClass()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//和上面调用的一个方法</span></span><br><span class="line">    ConfigurationPropertySources.attach(environment);</span><br><span class="line">    <span class="keyword">return</span> environment;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建和配置环境变量"><a href="#创建和配置环境变量" class="headerlink" title="创建和配置环境变量"></a>创建和配置环境变量</h3><p>进入<code>getOrCreateEnvironment</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ConfigurableEnvironment <span class="title function_">getOrCreateEnvironment</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//如果不为null直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.environment != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.environment;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//根据当前应用类型初始化不同的环境变量</span></span><br><span class="line">    <span class="keyword">switch</span> (<span class="built_in">this</span>.webApplicationType) &#123;</span><br><span class="line">        <span class="keyword">case</span> SERVLET:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StandardServletEnvironment</span>();</span><br><span class="line">        <span class="keyword">case</span> REACTIVE:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StandardReactiveWebEnvironment</span>();</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StandardEnvironment</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一般的非响应式的web项目项目类型都是<code>SERVLET</code>，所以会返回<code>StandardServletEnvironment</code>类型对象</p>
<p>获取环境对象后，进入<code>configureEnvironment(environment, applicationArguments.getSourceArgs())</code>方法，配置环境信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configureEnvironment</span><span class="params">(ConfigurableEnvironment environment, String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">//设置类型转换的服务接口</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.addConversionService) &#123;</span><br><span class="line">        <span class="type">ConversionService</span> <span class="variable">conversionService</span> <span class="operator">=</span> ApplicationConversionService.getSharedInstance();</span><br><span class="line">        environment.setConversionService((ConfigurableConversionService) conversionService);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//该方法会将args封装成SimpleCommandLinePropertySource对象</span></span><br><span class="line">    <span class="comment">//然后注入到environment的propertySources属性中(args不为空的话)</span></span><br><span class="line">    configurePropertySources(environment, args);</span><br><span class="line">    <span class="comment">//激活配置文件，其实就是将配置添加到environment的activeProfiles属性中</span></span><br><span class="line">    configureProfiles(environment, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>environment</code>对象内容如下</p>
<p><img src="/../../../../images/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/image-20211206230025019.png" alt="image-20211206230025019"></p>
<p>将propertySources展开就可以看到：</p>
<p><img src="/../../../../images/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/image-20211206230559761.png" alt="image-20211206230559761"></p>
<p>上面<code>name</code>为环境的标识，<code>source</code>保存的是相关信息，此处展开的是环境信息，除此之外还有jdk信息、命令行参数信息等等。例如命令行参数的配置信息<code>name</code>为<em>commandLineArgs</em></p>
<p>上面都完成之后会调用<code>ConfigurationPropertySources.attach(environment)</code>方法，该方法作用就是添加一个新建的name为configurationProperties的source，至此环境配置结束。</p>
<h3 id="启动响应监听器"><a href="#启动响应监听器" class="headerlink" title="启动响应监听器"></a>启动响应监听器</h3><p>启动监听器的部分包括：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//（2）启动响应监听器</span></span><br><span class="line">listeners.environmentPrepared(environment);</span><br><span class="line"><span class="comment">//将environment绑定到SpringApplication上</span></span><br><span class="line"><span class="comment">//里面只有一行代码：Binder.get(environment).bind(&quot;spring.main&quot;, Bindable.ofInstance(this));</span></span><br><span class="line">bindToSpringApplication(environment);</span><br><span class="line"><span class="comment">//是自定义环境</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">this</span>.isCustomEnvironment) &#123;</span><br><span class="line">    <span class="comment">//添加环境转换器</span></span><br><span class="line">    environment = <span class="keyword">new</span> <span class="title class_">EnvironmentConverter</span>(getClassLoader()).convertEnvironmentIfNecessary(</span><br><span class="line">        environment,</span><br><span class="line">        deduceEnvironmentClass()</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//和上面调用的一个方法</span></span><br><span class="line">ConfigurationPropertySources.attach(environment);</span><br><span class="line"><span class="keyword">return</span> environment;</span><br></pre></td></tr></table></figure>

<p>首先进入<code>environmentPrepared</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">environmentPrepared</span><span class="params">(ConfigurableEnvironment environment)</span> &#123;</span><br><span class="line">    <span class="comment">//遍历this.listeners，里面只有一个元素，就是上面获取的EventPublishingRunListener</span></span><br><span class="line">    <span class="keyword">for</span> (SpringApplicationRunListener listener : <span class="built_in">this</span>.listeners) &#123;</span><br><span class="line">        listener.environmentPrepared(environment);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终会进入Spring的方法如下方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">multicastEvent</span><span class="params">(ApplicationEvent event, <span class="meta">@Nullable</span> ResolvableType eventType)</span> &#123;</span><br><span class="line">    <span class="type">ResolvableType</span> <span class="variable">type</span> <span class="operator">=</span> eventType != <span class="literal">null</span> ? eventType : <span class="built_in">this</span>.resolveDefaultEventType(event);</span><br><span class="line">    <span class="comment">//获取任务执行器</span></span><br><span class="line">    <span class="type">Executor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="built_in">this</span>.getTaskExecutor();</span><br><span class="line">    <span class="comment">//主要是这里</span></span><br><span class="line">    <span class="comment">//获取了一个迭代器，里面是监听器</span></span><br><span class="line">    <span class="type">Iterator</span> <span class="variable">var5</span> <span class="operator">=</span> <span class="built_in">this</span>.getApplicationListeners(event, type).iterator();</span><br><span class="line">	<span class="comment">//下面依次进行遍历</span></span><br><span class="line">    <span class="keyword">while</span>(var5.hasNext()) &#123;</span><br><span class="line">        ApplicationListener&lt;?&gt; listener = (ApplicationListener)var5.next();</span><br><span class="line">        <span class="comment">//如果executor不为null</span></span><br><span class="line">        <span class="keyword">if</span> (executor != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//用executor进行执行</span></span><br><span class="line">            executor.execute(() -&gt; &#123;</span><br><span class="line">                <span class="built_in">this</span>.invokeListener(listener, event);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//否则直接执行</span></span><br><span class="line">            <span class="built_in">this</span>.invokeListener(listener, event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面获取迭代器的<code>this.getApplicationListeners(event, type)</code>得到的值其实就是初始化时的11个监听器中的七个（这7个单独在同一个spring.factories文件中）</p>
<p><img src="/../../../../images/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/image-20211206233228333-16388047522621.png" alt="image-20211206233228333"></p>
<p>其中第一个监听器<code>ConfigFileApplicationListener</code>就是用于加载配置文件（yml和propertise）的，进入这个监听器内可以看到如下注解（这里为了方便看，我将英文全部替换成中文）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 默认会加载&#x27;application.properties&#x27; and/or &#x27;application.yml&#x27;两个文件内容来配置上下文，</span></span><br><span class="line"><span class="comment"> * 会在下面四个路径中寻找配置文件</span></span><br><span class="line"><span class="comment"> * &lt;ul&gt;</span></span><br><span class="line"><span class="comment"> * file是工程根目录，和src同级</span></span><br><span class="line"><span class="comment"> * classpath是resource下</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;file:./config/&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;file:./&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;classpath:config/&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;classpath:&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment"> * 该列表按优先级排序（在列表中较高位置定义的属性覆盖在较低位置定义的属性）。</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 可以使用特定的&#123;<span class="doctag">@link</span> #setSearchLocations(String)&#125; 和 &#123;<span class="doctag">@link</span> #setSearchNames(String)&#125;</span></span><br><span class="line"><span class="comment"> * 来替代搜索的位置和名称</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 还将根据动态配置加载其他文件。</span></span><br><span class="line"><span class="comment"> * 例如，如果“web”配置文件处于活动状态，则将考虑加载“application-web.properties”和“application-web.yml”。</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * “spring.config.name”属性可用于指定要加载的替代名称，</span></span><br><span class="line"><span class="comment"> * “spring.config.location”属性可用于指定替代搜索位置或特定文件。</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigFileApplicationListener</span> <span class="keyword">implements</span> <span class="title class_">EnvironmentPostProcessor</span>, SmartApplicationListener, Ordered &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总之，使用<code>EventPublishingRunListener</code>监听器来触发这7个监听器中只有<code>ConfigFileApplicationListener</code>监听器负责加载配置文件，然后注入到environment中</p>
<h4 id="配置文件加载规则"><a href="#配置文件加载规则" class="headerlink" title="配置文件加载规则"></a>配置文件加载规则</h4><p>根据上面<code>ConfigFileApplicationListener</code>类上的注释可以总结出spring boot配置文件加载方式，如下：</p>
<h5 id="默认加载顺序："><a href="#默认加载顺序：" class="headerlink" title="默认加载顺序："></a>默认加载顺序：</h5><ul>
<li><em>file:.&#x2F;config&#x2F;</em></li>
<li><em>file:.&#x2F;</em></li>
<li><em>classpath:config&#x2F;</em></li>
<li><em>classpath:</em></li>
</ul>
<blockquote>
<p><code>file</code>是工程根目录，和<code>src</code>同级</p>
<p><code>classpath</code>是<code>resource</code>路径下</p>
</blockquote>
<h5 id="加载规则："><a href="#加载规则：" class="headerlink" title="加载规则："></a>加载规则：</h5><ol>
<li>先加载的配置优先级更高</li>
<li>如果同级目录下存在yml和properties，则先读取properties</li>
<li>默认加载’application.properties’ 和 ‘application.yml’两个文件</li>
<li>还将根据动态配置加载其他文件，比如多环境下进行配置，使其加载application-dev或application-prop名字的文件文件</li>
<li><code>spring.config.name</code>属性可用于指定要加载的替代名称，</li>
<li><code>spring.config.location</code>属性可用于指定替代搜索位置或特定文件。</li>
</ol>
<h2 id="初始化上下文"><a href="#初始化上下文" class="headerlink" title="初始化上下文"></a>初始化上下文</h2><p>该部分相关代码为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//上下文对象</span></span><br><span class="line"><span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">Collection&lt;SpringBootExceptionReporter&gt; exceptionReporters = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">...</span><br><span class="line"><span class="comment">//3、初始化上下文</span></span><br><span class="line">context = createApplicationContext();</span><br><span class="line"><span class="comment">//又是这个方法，根据传入的class作为key，创建spring.factories文件中对应的对象</span></span><br><span class="line"><span class="comment">//exceptionReporters主要是用来报告spring boot启动过程中的错误</span></span><br><span class="line">exceptionReporters = getSpringFactoriesInstances(SpringBootExceptionReporter.class,</span><br><span class="line">                     	<span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; ConfigurableApplicationContext.class &#125;,</span><br><span class="line">                        context);</span><br></pre></td></tr></table></figure>

<p>上下文对象即为<code>ConfigurableApplicationContext</code>类型的<code>context</code>对象。<code>ConfigurableApplicationContext</code>是<code>ApplicationContext</code>的子类并在其之上增加了配置上下文的工具，具体类图如下：</p>
<p><img src="/../../../../images/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/image-20211207232406815.png" alt="image-20211207232406815"></p>
<p>从上图可以看到<code>BeanFactory</code>类，它提供了ioc容器的最基本形式，它的实现类包括 <code>DefaultListableBeanFactory</code>（spring boot用的是这个）、<code>XmlBeanFactory</code>、<code>ApplicationContext</code>等</p>
<p>进入<code>createApplicationContext</code>方法中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_SERVLET_WEB_CONTEXT_CLASS</span> <span class="operator">=</span> <span class="string">&quot;org.springframework.boot.&quot;</span></span><br><span class="line">			+ <span class="string">&quot;web.servlet.context.AnnotationConfigServletWebServerApplicationContext&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_REACTIVE_WEB_CONTEXT_CLASS</span> <span class="operator">=</span> <span class="string">&quot;org.springframework.&quot;</span></span><br><span class="line">			+ <span class="string">&quot;boot.web.reactive.context.AnnotationConfigReactiveWebServerApplicationContext&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_CONTEXT_CLASS</span> <span class="operator">=</span> <span class="string">&quot;org.springframework.context.&quot;</span></span><br><span class="line">			+ <span class="string">&quot;annotation.AnnotationConfigApplicationContext&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> ConfigurableApplicationContext <span class="title function_">createApplicationContext</span><span class="params">()</span> &#123;</span><br><span class="line">    Class&lt;?&gt; contextClass = <span class="built_in">this</span>.applicationContextClass;</span><br><span class="line">    <span class="comment">//如果还没初始化上下文</span></span><br><span class="line">    <span class="keyword">if</span> (contextClass == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//根据应用类型加载不同的contextClass类</span></span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">this</span>.webApplicationType) &#123;</span><br><span class="line">                <span class="keyword">case</span> SERVLET:</span><br><span class="line">                    contextClass = Class.forName(DEFAULT_SERVLET_WEB_CONTEXT_CLASS);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> REACTIVE:</span><br><span class="line">                    contextClass = Class.forName(DEFAULT_REACTIVE_WEB_CONTEXT_CLASS);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    contextClass = Class.forName(DEFAULT_CONTEXT_CLASS);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">                <span class="string">&quot;Unable create a default ApplicationContext, please specify an ApplicationContextClass&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//根据加载到的contextClass进行实例化并转换类型后返回</span></span><br><span class="line">    <span class="keyword">return</span> (ConfigurableApplicationContext) BeanUtils.instantiateClass(contextClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面三个常量所对应的类的继承关系基本一致所以下面只列出<code>AnnotationConfigServletWebServerApplicationContext</code>的类关系图</p>
<p><img src="/../../../../images/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/image-20211207231809004.png" alt="image-20211207231809004"></p>
<p>其他两个类的继承关系的结构和上图基本一致，只不过某些类的实现和名称不同</p>
<p>上下文对象创建完成后<code>context</code>中的<code>beanFactory</code></p>
<p><img src="/../../../../images/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/image-20211207233212115.png" alt="image-20211207233212115"></p>
<h2 id="刷新应用上下文准备阶段"><a href="#刷新应用上下文准备阶段" class="headerlink" title="刷新应用上下文准备阶段"></a>刷新应用上下文准备阶段</h2><p>刷新上下文准备阶段主要代码为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//4、刷新应用上下文前的准备阶段</span></span><br><span class="line">prepareContext(context, environment, listeners, applicationArguments, printedBanner);</span><br></pre></td></tr></table></figure>

<p>进入<code>refreshContext</code>方法中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">prepareContext</span><span class="params">(ConfigurableApplicationContext context, ConfigurableEnvironment environment,</span></span><br><span class="line"><span class="params">                            SpringApplicationRunListeners listeners, ApplicationArguments applicationArguments, Banner printedBanner)</span> &#123;</span><br><span class="line">    <span class="comment">//将上一步获取的环境对象赋值给应用上下文对象</span></span><br><span class="line">    context.setEnvironment(environment);</span><br><span class="line">    <span class="comment">//（1）应用上下文后置方法，主要是添加转换器</span></span><br><span class="line">    postProcessApplicationContext(context);</span><br><span class="line">    <span class="comment">//（2）应用上面获取的那些初始化器</span></span><br><span class="line">    applyInitializers(context);</span><br><span class="line">    <span class="comment">//向第一步获取的监听器发送事件，这个监听器会触发其他相关监听器</span></span><br><span class="line">    listeners.contextPrepared(context);</span><br><span class="line">    <span class="comment">//记录启动信息</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.logStartupInfo) &#123;</span><br><span class="line">        logStartupInfo(context.getParent() == <span class="literal">null</span>);</span><br><span class="line">        logStartupProfileInfo(context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Add boot specific singleton beans</span></span><br><span class="line">    <span class="comment">//增加指定的单例bean</span></span><br><span class="line">    <span class="comment">//获取ioc容器</span></span><br><span class="line">    <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> context.getBeanFactory();</span><br><span class="line">    <span class="comment">//将main函数的参数封装成bean并注册</span></span><br><span class="line">    beanFactory.registerSingleton(<span class="string">&quot;springApplicationArguments&quot;</span>, applicationArguments);</span><br><span class="line">    <span class="comment">//用于打印启动图标的printedBanner不为空，则注册</span></span><br><span class="line">    <span class="keyword">if</span> (printedBanner != <span class="literal">null</span>) &#123;</span><br><span class="line">        beanFactory.registerSingleton(<span class="string">&quot;springBootBanner&quot;</span>, printedBanner);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//beanFactory真实类型是DefaultListableBeanFactory</span></span><br><span class="line">    <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> DefaultListableBeanFactory) &#123;</span><br><span class="line">        ((DefaultListableBeanFactory) beanFactory)</span><br><span class="line">        .setAllowBeanDefinitionOverriding(<span class="built_in">this</span>.allowBeanDefinitionOverriding);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//是否懒加载</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.lazyInitialization) &#123;</span><br><span class="line">        context.addBeanFactoryPostProcessor(<span class="keyword">new</span> <span class="title class_">LazyInitializationBeanFactoryPostProcessor</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//（3）加载启动类</span></span><br><span class="line">    <span class="comment">//拿到启动类，set中只有一个对象，启动类</span></span><br><span class="line">    Set&lt;Object&gt; sources = getAllSources();</span><br><span class="line">    Assert.notEmpty(sources, <span class="string">&quot;Sources must not be empty&quot;</span>);</span><br><span class="line">    <span class="comment">//注册启动类</span></span><br><span class="line">    load(context, sources.toArray(<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]));</span><br><span class="line">    <span class="comment">//发布事件</span></span><br><span class="line">    listeners.contextLoaded(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="应用上下文后置方法"><a href="#应用上下文后置方法" class="headerlink" title="应用上下文后置方法"></a>应用上下文后置方法</h3><p>应用上下文后置方法为<code>postProcessApplicationContext(context)</code>它的作用就是添加了大量的转换器，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">postProcessApplicationContext</span><span class="params">(ConfigurableApplicationContext context)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.beanNameGenerator != <span class="literal">null</span>) &#123;</span><br><span class="line">    	context.getBeanFactory().registerSingleton(</span><br><span class="line">            AnnotationConfigUtils.CONFIGURATION_BEAN_NAME_GENERATOR,<span class="built_in">this</span>.beanNameGenerator);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.resourceLoader != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (context <span class="keyword">instanceof</span> GenericApplicationContext) &#123;</span><br><span class="line">            ((GenericApplicationContext) context).setResourceLoader(<span class="built_in">this</span>.resourceLoader);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (context <span class="keyword">instanceof</span> DefaultResourceLoader) &#123;</span><br><span class="line">            ((DefaultResourceLoader) context).setClassLoader(<span class="built_in">this</span>.resourceLoader.getClassLoader());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//添加转换器</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.addConversionService) &#123;</span><br><span class="line">        <span class="comment">//ConversionService 是一个类型转换服务接口，并且还是线程安全的。</span></span><br><span class="line">        <span class="comment">//ApplicationConversionService是他的一个实现类，里面包含了一大堆转换器</span></span><br><span class="line">        context.getBeanFactory().setConversionService(ApplicationConversionService.getSharedInstance());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里主要关注的是<code>getSharedInstance</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getSharedInstance()这里使用了单例模式</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ConversionService <span class="title function_">getSharedInstance</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ApplicationConversionService</span> <span class="variable">sharedInstance</span> <span class="operator">=</span> ApplicationConversionService.sharedInstance;</span><br><span class="line">    <span class="comment">//双重锁检查</span></span><br><span class="line">    <span class="keyword">if</span> (sharedInstance == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (ApplicationConversionService.class) &#123;</span><br><span class="line">            sharedInstance = ApplicationConversionService.sharedInstance;</span><br><span class="line">            <span class="keyword">if</span> (sharedInstance == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//新建ApplicationConversionService对象</span></span><br><span class="line">                sharedInstance = <span class="keyword">new</span> <span class="title class_">ApplicationConversionService</span>();</span><br><span class="line">                ApplicationConversionService.sharedInstance = sharedInstance;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sharedInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出，这里使用了单例模式，创建了<code>ApplicationConversionService</code>对象，进入该构造方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ApplicationConversionService</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ApplicationConversionService</span><span class="params">(StringValueResolver embeddedValueResolver)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (embeddedValueResolver != <span class="literal">null</span>) &#123;</span><br><span class="line">        setEmbeddedValueResolver(embeddedValueResolver);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//给this添加一堆转换器</span></span><br><span class="line">    configure(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//主要是configure(this)方法，它负责注入各种类型的转换器</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(FormatterRegistry registry)</span> &#123;</span><br><span class="line">    <span class="comment">//添加默认转换器，也就是适用于大多数环境的转换器。</span></span><br><span class="line">    DefaultConversionService.addDefaultConverters(registry);</span><br><span class="line">    <span class="comment">//添加默认格式化程序，适用于大多数环境的格式化程序：包括数字格式化程序，JSR-354货币和货币格式化程序，</span></span><br><span class="line">    <span class="comment">//JSR-310日期时间格式化程序和/或Joda时间格式化程序，具体取决于类路径上相应API的存在。</span></span><br><span class="line">    DefaultFormattingConversionService.addDefaultFormatters(registry);</span><br><span class="line">    <span class="comment">//添加对大多数Spring Boot应用程序有用的格式化程序。</span></span><br><span class="line">    addApplicationFormatters(registry);</span><br><span class="line">    <span class="comment">//添加对大多数Spring Boot应用程序有用的转换器。</span></span><br><span class="line">    addApplicationConverters(registry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="应用初始化器"><a href="#应用初始化器" class="headerlink" title="应用初始化器"></a>应用初始化器</h3><p>这里的初始化器指的是初始化阶段获取的那些，此处会调用他们进行初始化操作，每个初始化器执行的逻辑各有不同，进入<code>applyInitializers</code>方法中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&#123; &quot;rawtypes&quot;, &quot;unchecked&quot; &#125;)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">applyInitializers</span><span class="params">(ConfigurableApplicationContext context)</span> &#123;</span><br><span class="line">    <span class="comment">//遍历初始化阶段获取的初始化器</span></span><br><span class="line">    <span class="keyword">for</span> (ApplicationContextInitializer initializer : getInitializers()) &#123;</span><br><span class="line">        <span class="comment">//泛型工具类，resolveTypeArgument用来解析泛型参数</span></span><br><span class="line">        <span class="comment">//这一步的的作用就是获取按照initializer的继承链向上找</span></span><br><span class="line">        <span class="comment">//直到ApplicationContextInitializer类，</span></span><br><span class="line">        <span class="comment">//然后获取ApplicationContextInitializer类此时泛型的真实类型</span></span><br><span class="line">        <span class="comment">//如果没有则返回空值</span></span><br><span class="line">        Class&lt;?&gt; requiredType = GenericTypeResolver.resolveTypeArgument(initializer.getClass(),</span><br><span class="line">                                                                        ApplicationContextInitializer.class);</span><br><span class="line">        <span class="comment">//判断context是不是上面的泛型类型的实例</span></span><br><span class="line">        Assert.isInstanceOf(requiredType, context, <span class="string">&quot;Unable to call initializer.&quot;</span>);</span><br><span class="line">        <span class="comment">//没问题了就初始化，这里每次遍历的initializer对象不同，经路的initialize方法实现也不同</span></span><br><span class="line">        <span class="comment">//但基本都是为context执行一些初始化的操作，添加和设置一些东西包括上下文id，监听器等</span></span><br><span class="line">        initializer.initialize(context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="加载启动类"><a href="#加载启动类" class="headerlink" title="加载启动类"></a>加载启动类</h3><p>这里主要的方法为<code>load(context, sources.toArray(new Object[0]))</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">load</span><span class="params">(ApplicationContext context, Object[] sources)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;Loading source &quot;</span> + StringUtils.arrayToCommaDelimitedString(sources));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取loader</span></span><br><span class="line">    <span class="comment">//getBeanDefinitionRegistry(context)获取的register对象用于加载definition对象到ioc容器中</span></span><br><span class="line">    <span class="type">BeanDefinitionLoader</span> <span class="variable">loader</span> <span class="operator">=</span> createBeanDefinitionLoader(getBeanDefinitionRegistry(context), sources);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.beanNameGenerator != <span class="literal">null</span>) &#123;</span><br><span class="line">        loader.setBeanNameGenerator(<span class="built_in">this</span>.beanNameGenerator);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.resourceLoader != <span class="literal">null</span>) &#123;</span><br><span class="line">        loader.setResourceLoader(<span class="built_in">this</span>.resourceLoader);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.environment != <span class="literal">null</span>) &#123;</span><br><span class="line">        loader.setEnvironment(<span class="built_in">this</span>.environment);</span><br><span class="line">    &#125;</span><br><span class="line">    loader.load();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入<code>load</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">load</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (Object source : <span class="built_in">this</span>.sources) &#123;</span><br><span class="line">        <span class="comment">//调用重载方法</span></span><br><span class="line">        count += load(source);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//重载方法</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">load</span><span class="params">(Object source)</span> &#123;</span><br><span class="line">    Assert.notNull(source, <span class="string">&quot;Source must not be null&quot;</span>);</span><br><span class="line">    <span class="comment">//从Class加载</span></span><br><span class="line">    <span class="comment">//source是启动类，会进入这里</span></span><br><span class="line">    <span class="keyword">if</span> (source <span class="keyword">instanceof</span> Class&lt;?&gt;) &#123;</span><br><span class="line">        <span class="keyword">return</span> load((Class&lt;?&gt;) source);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//从Resource加载</span></span><br><span class="line">    <span class="keyword">if</span> (source <span class="keyword">instanceof</span> Resource) &#123;</span><br><span class="line">        <span class="keyword">return</span> load((Resource) source);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//从Package加载</span></span><br><span class="line">    <span class="keyword">if</span> (source <span class="keyword">instanceof</span> Package) &#123;</span><br><span class="line">        <span class="keyword">return</span> load((Package) source);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//从CharSequence加载</span></span><br><span class="line">    <span class="keyword">if</span> (source <span class="keyword">instanceof</span> CharSequence) &#123;</span><br><span class="line">        <span class="keyword">return</span> load((CharSequence) source);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Invalid source type &quot;</span> + source.getClass());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//最终调用</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">load</span><span class="params">(Class&lt;?&gt; source)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isGroovyPresent() &amp;&amp; GroovyBeanDefinitionSource.class.isAssignableFrom(source)) &#123;</span><br><span class="line">        <span class="comment">// Any GroovyLoaders added in beans&#123;&#125; DSL can contribute beans here</span></span><br><span class="line">        <span class="type">GroovyBeanDefinitionSource</span> <span class="variable">loader</span> <span class="operator">=</span> BeanUtils.instantiateClass(source, GroovyBeanDefinitionSource.class);</span><br><span class="line">        load(loader);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//是否标记了@Component，启动类上的组合注解包括该注解</span></span><br><span class="line">    <span class="keyword">if</span> (isComponent(source)) &#123;</span><br><span class="line">        <span class="comment">//注册启动类</span></span><br><span class="line">        <span class="built_in">this</span>.annotatedReader.register(source);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="刷新应用上下文"><a href="#刷新应用上下文" class="headerlink" title="刷新应用上下文"></a>刷新应用上下文</h2><p>这部分是spring boot自动配置的核心，相关代码为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.refreshContext(context);</span><br></pre></td></tr></table></figure>

<p>由于这里主要使用spring的方法，而且嵌套过多，所以只列出相关代码其他省略，进入<code>refreshContext</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">refreshContext</span><span class="params">(ConfigurableApplicationContext context)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.registerShutdownHook) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            context.registerShutdownHook();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (AccessControlException var3) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//主要方法</span></span><br><span class="line">    <span class="built_in">this</span>.refresh((ApplicationContext)context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//进入this.refresh</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">(ApplicationContext applicationContext)</span> &#123;</span><br><span class="line">    Assert.isInstanceOf(ConfigurableApplicationContext.class, applicationContext);</span><br><span class="line">    <span class="comment">//主要方法</span></span><br><span class="line">    <span class="built_in">this</span>.refresh((ConfigurableApplicationContext)applicationContext);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//进入this.refresh</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">(ConfigurableApplicationContext applicationContext)</span> &#123;</span><br><span class="line">	applicationContext.refresh();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//进入applicationContext.refresh</span></span><br><span class="line"><span class="comment">//这里是spring的源码，主要需要关注invokeBeanFactoryPostProcessors(beanFactory)方法的部分</span></span><br><span class="line"><span class="comment">//它完成了ioc容器的上下文初始化过程</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">        <span class="comment">// Prepare this context for refreshing.</span></span><br><span class="line">        <span class="comment">//刷新上下文环境</span></span><br><span class="line">        prepareRefresh();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//这里获取了spring boot之前创建的ioc容器</span></span><br><span class="line">        <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> <span class="built_in">this</span>.obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//准备bean工厂，以便在此上下文中使用</span></span><br><span class="line">        prepareBeanFactory(beanFactory);</span><br><span class="line">        obtainFreshBeanFactory();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//设置 beanFactory 的后置处理</span></span><br><span class="line">            postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//调用 BeanFactory 的后处理器，这些处理器是在Bean 定义中向容器注册的</span></span><br><span class="line">            invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//注册Bean的后处理器，在Bean创建过程中调用</span></span><br><span class="line">            registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//对上下文中的消息源进行初始化</span></span><br><span class="line">            initMessageSource();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//初始化上下文中的事件机制</span></span><br><span class="line">            initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//初始化其他特殊的Bean</span></span><br><span class="line">            onRefresh();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//检查监听Bean并且将这些监听Bean向容器注册</span></span><br><span class="line">            registerListeners();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//实例化所有的（non-lazy-init）单件</span></span><br><span class="line">            finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//发布容器事件，结束Refresh过程</span></span><br><span class="line">            finishRefresh();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;Exception encountered during context</span></span><br><span class="line"><span class="string">                            initialization - &quot;</span> +</span><br><span class="line">                            <span class="string">&quot;cancelling refresh attempt: &quot;</span> + ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Destroy already created singletons to avoid dangling</span></span><br><span class="line">            resources.</span><br><span class="line">                destroyBeans();</span><br><span class="line">            <span class="comment">// Reset &#x27;active&#x27; flag.</span></span><br><span class="line">            cancelRefresh(ex);</span><br><span class="line">            <span class="comment">// Propagate exception to caller.</span></span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// Reset common introspection caches in Spring&#x27;s core, since we</span></span><br><span class="line">            <span class="comment">// might not ever need metadata for singleton beans anymore...</span></span><br><span class="line">            resetCommonCaches();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入<code>invokeBeanFactoryPostProcessors</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">invokeBeanFactoryPostProcessors</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">    PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, <span class="built_in">this</span>.getBeanFactoryPostProcessors());</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//进入invokeBeanFactoryPostProcessors方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">invokeBeanFactoryPostProcessors</span><span class="params">(ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors)</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> BeanDefinitionRegistry) &#123;</span><br><span class="line">        <span class="type">BeanDefinitionRegistry</span> <span class="variable">registry</span> <span class="operator">=</span> (BeanDefinitionRegistry)beanFactory;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//进入invokeBeanDefinitionRegistryPostProcessors方法</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">invokeBeanDefinitionRegistryPostProcessors</span><span class="params">(Collection&lt;? extends BeanDefinitionRegistryPostProcessor&gt; postProcessors, BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">    <span class="type">Iterator</span> <span class="variable">var2</span> <span class="operator">=</span> postProcessors.iterator();</span><br><span class="line">    <span class="comment">//遍历postProcessors并执行postProcessBeanDefinitionRegistry方法</span></span><br><span class="line">    <span class="keyword">while</span>(var2.hasNext()) &#123;</span><br><span class="line">        <span class="type">BeanDefinitionRegistryPostProcessor</span> <span class="variable">postProcessor</span> <span class="operator">=</span> (BeanDefinitionRegistryPostProcessor)var2.next();</span><br><span class="line">        <span class="comment">//主要方法</span></span><br><span class="line">        postProcessor.postProcessBeanDefinitionRegistry(registry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//进入postProcessBeanDefinitionRegistry方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    <span class="built_in">this</span>.processConfigBeanDefinitions(registry);</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//进入processConfigBeanDefinitions方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processConfigBeanDefinitions</span><span class="params">(BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">    List&lt;BeanDefinitionHolder&gt; configCandidates = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">    <span class="comment">//中间过程为configCandidates添加了一个数据（启动类的BeanDefinitionHolder）</span></span><br><span class="line">    <span class="keyword">if</span>(...)&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        configCandidates.add(<span class="keyword">new</span> <span class="title class_">BeanDefinitionHolder</span>(beanDef, beanName));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//转换为set，应该是为了去重</span></span><br><span class="line">    Set&lt;BeanDefinitionHolder&gt; candidates = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>(configCandidates);</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">//（1）这里面会解析各个注解，包括组合类中的两个@import，获取自动配置类</span></span><br><span class="line">        parser.parse(candidates);</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="comment">//获取了configClasses，后面将此作为参数传入loadBeanDefinitions开始注册过程</span></span><br><span class="line">        Set&lt;ConfigurationClass&gt; configClasses = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>(parser.getConfigurationClasses());</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="comment">//（2）将获取的自动配置类加载到ioc中</span></span><br><span class="line">        <span class="built_in">this</span>.reader.loadBeanDefinitions(configClasses);</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;<span class="keyword">while</span>(!candidates.isEmpty());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到了这里一共有两个重要的方法，下面分别讨论</p>
<h3 id="parse方法"><a href="#parse方法" class="headerlink" title="parse方法"></a><code>parse</code>方法</h3><p>进入到<code>ConfigurationClassParser</code>类的<code>parse</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parse</span><span class="params">(Set&lt;BeanDefinitionHolder&gt; configCandidates)</span> &#123;</span><br><span class="line">    <span class="comment">//便利configCandidates，此时只有一个启动类</span></span><br><span class="line">    <span class="type">Iterator</span> <span class="variable">var2</span> <span class="operator">=</span> configCandidates.iterator();</span><br><span class="line">    <span class="keyword">while</span>(var2.hasNext()) &#123;</span><br><span class="line">        <span class="type">BeanDefinitionHolder</span> <span class="variable">holder</span> <span class="operator">=</span> (BeanDefinitionHolder)var2.next();</span><br><span class="line">        <span class="type">BeanDefinition</span> <span class="variable">bd</span> <span class="operator">=</span> holder.getBeanDefinition();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//前面将启动类封装成了AnnotatedBeanDefinition类型并注入ioc容器中</span></span><br><span class="line">            <span class="keyword">if</span> (bd <span class="keyword">instanceof</span> AnnotatedBeanDefinition) &#123;</span><br><span class="line">                <span class="comment">//【1】、【2】步骤在这里面</span></span><br><span class="line">                <span class="comment">//该方法主要就是解析各个注解的</span></span><br><span class="line">                <span class="built_in">this</span>.parse(((AnnotatedBeanDefinition)bd).getMetadata(), holder.getBeanName());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (...) &#123;</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (BeanDefinitionStoreException var6) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var6;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var7) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionStoreException</span>(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】加载默认的配置---》（对springboot项目来说这里就是自动装配的入口了）</span></span><br><span class="line">    <span class="built_in">this</span>.deferredImportSelectorHandler.process();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意这里<code>this.parse(((AnnotatedBeanDefinition)bd).getMetadata(), holder.getBeanName());</code>这个方法会解析类上的注解，并且该方法会递归调用，递归的情况有两种：</p>
<ul>
<li>在这个方法执行过程中会判断当前类上是否有<code>@Component/@Configuration</code>注解，如果有就会递归调用<code>parse</code>方法</li>
<li>在此方法内处理<code>@import</code>注解时会通过调用<code>processImports</code>方法查找并引入相关的类，此时也会递归调用<code>parse</code>方法</li>
</ul>
<p>进入<code>parse</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">parse</span><span class="params">(AnnotationMetadata metadata, String beanName)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="built_in">this</span>.processConfigurationClass(<span class="keyword">new</span> <span class="title class_">ConfigurationClass</span>(metadata, beanName), DEFAULT_EXCLUSION_FILTER);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//进入processConfigurationClass</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">processConfigurationClass</span><span class="params">(ConfigurationClass configClass, Predicate&lt;String&gt; filter)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//这里会进行校验，符合条件才会执行下面方法</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">//这里sourceClass为启动类</span></span><br><span class="line">    ConfigurationClassParser.<span class="type">SourceClass</span> <span class="variable">sourceClass</span> <span class="operator">=</span> </span><br><span class="line">        <span class="built_in">this</span>.asSourceClass(configClass, filter);</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">//递归处理Bean，如果有父类，递归处理，直到顶层父类</span></span><br><span class="line">        sourceClass = <span class="built_in">this</span>.doProcessConfigurationClass(configClass, sourceClass, filter);</span><br><span class="line">    &#125; <span class="keyword">while</span>(sourceClass != <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.configurationClasses.put(configClass, configClass);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//进入doProcessConfigurationClass方法，spring中do开头的才是真正干活的方法</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> ConfigurationClassParser.SourceClass <span class="title function_">doProcessConfigurationClass</span><span class="params">(ConfigurationClass configClass, ConfigurationClassParser.SourceClass sourceClass, Predicate&lt;String&gt; filter)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//处理内部类</span></span><br><span class="line">    <span class="keyword">if</span> (configClass.getMetadata().isAnnotated(Component.class.getName())) &#123;</span><br><span class="line">        <span class="built_in">this</span>.processMemberClasses(configClass, sourceClass, filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理@PropertySource注解</span></span><br><span class="line">    <span class="comment">//并将该注解指定的properties配置文件中的值存储到Spring的 Environment中</span></span><br><span class="line">    <span class="comment">//Environment接口提供方法去读取配置文件中的值，参数是properties文件中定义的key值。</span></span><br><span class="line">    <span class="type">Iterator</span> <span class="variable">var4</span> <span class="operator">=</span> AnnotationConfigUtils.attributesForRepeatable(sourceClass.getMetadata(), PropertySources.class, PropertySource.class).iterator();</span><br><span class="line"></span><br><span class="line">    AnnotationAttributes importResource;</span><br><span class="line">    <span class="keyword">while</span>(var4.hasNext()) &#123;</span><br><span class="line">        importResource = (AnnotationAttributes)var4.next();</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.environment <span class="keyword">instanceof</span> ConfigurableEnvironment) &#123;</span><br><span class="line">            <span class="built_in">this</span>.processPropertySource(importResource);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.logger.info(<span class="string">&quot;Ignoring @PropertySource annotation on [&quot;</span> + sourceClass.getMetadata().getClassName() + <span class="string">&quot;]. Reason: Environment must implement ConfigurableEnvironment&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】处理@ComponentScan注解</span></span><br><span class="line">    Set&lt;AnnotationAttributes&gt; componentScans = AnnotationConfigUtils.attributesForRepeatable(sourceClass.getMetadata(), ComponentScans.class, ComponentScan.class);</span><br><span class="line">    <span class="keyword">if</span> (!componentScans.isEmpty() &amp;&amp; !<span class="built_in">this</span>.conditionEvaluator.shouldSkip(sourceClass.getMetadata(), ConfigurationPhase.REGISTER_BEAN)) &#123;</span><br><span class="line">        <span class="type">Iterator</span> <span class="variable">var14</span> <span class="operator">=</span> componentScans.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var14.hasNext()) &#123;</span><br><span class="line">            <span class="type">AnnotationAttributes</span> <span class="variable">componentScan</span> <span class="operator">=</span> (AnnotationAttributes)var14.next();</span><br><span class="line">            <span class="comment">//执行扫描</span></span><br><span class="line">            Set&lt;BeanDefinitionHolder&gt; scannedBeanDefinitions = <span class="built_in">this</span>.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName());</span><br><span class="line">            <span class="type">Iterator</span> <span class="variable">var8</span> <span class="operator">=</span> scannedBeanDefinitions.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var8.hasNext()) &#123;</span><br><span class="line">                <span class="type">BeanDefinitionHolder</span> <span class="variable">holder</span> <span class="operator">=</span> (BeanDefinitionHolder)var8.next();</span><br><span class="line">                <span class="type">BeanDefinition</span> <span class="variable">bdCand</span> <span class="operator">=</span> holder.getBeanDefinition().getOriginatingBeanDefinition();</span><br><span class="line">                <span class="keyword">if</span> (bdCand == <span class="literal">null</span>) &#123;</span><br><span class="line">                    bdCand = holder.getBeanDefinition();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//检查是否是配置类（有@configuration/@component注解），则递归查找关联类</span></span><br><span class="line">                <span class="comment">//关联类包括内部的@bean注解定义的bean或者@import注解引入的类</span></span><br><span class="line">                <span class="keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(bdCand, <span class="built_in">this</span>.metadataReaderFactory)) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.parse(bdCand.getBeanClassName(), holder.getBeanName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】处理@Import注解</span></span><br><span class="line">    <span class="comment">//这里的处理是递归的</span></span><br><span class="line">    <span class="comment">//SpringBoot项目中经常用的各种@Enable*** 注解基本都是封装的@Import</span></span><br><span class="line">    <span class="built_in">this</span>.processImports(configClass, sourceClass, <span class="built_in">this</span>.getImports(sourceClass), filter, <span class="literal">true</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//处理@ImportResource注解</span></span><br><span class="line">    importResource = AnnotationConfigUtils.attributesFor(sourceClass.getMetadata(), ImportResource.class);</span><br><span class="line">    <span class="keyword">if</span> (importResource != <span class="literal">null</span>) &#123;</span><br><span class="line">        String[] resources = importResource.getStringArray(<span class="string">&quot;locations&quot;</span>);</span><br><span class="line">        Class&lt;? <span class="keyword">extends</span> <span class="title class_">BeanDefinitionReader</span>&gt; readerClass = importResource.getClass(<span class="string">&quot;reader&quot;</span>);</span><br><span class="line">        String[] var20 = resources;</span><br><span class="line">        <span class="type">int</span> <span class="variable">var22</span> <span class="operator">=</span> resources.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">var23</span> <span class="operator">=</span> <span class="number">0</span>; var23 &lt; var22; ++var23) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">resource</span> <span class="operator">=</span> var20[var23];</span><br><span class="line">            <span class="type">String</span> <span class="variable">resolvedResource</span> <span class="operator">=</span> <span class="built_in">this</span>.environment.resolveRequiredPlaceholders(resource);</span><br><span class="line">            configClass.addImportedResource(resolvedResource, readerClass);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//先把@Bean的方法存入beanMethods,后面this.reader.loadBeanDefinitions(configClasses)会继续处理@Bean,那时候才会真正实例化@Bean;</span></span><br><span class="line">    Set&lt;MethodMetadata&gt; beanMethods = <span class="built_in">this</span>.retrieveBeanMethodMetadata(sourceClass);</span><br><span class="line">    <span class="type">Iterator</span> <span class="variable">var18</span> <span class="operator">=</span> beanMethods.iterator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(var18.hasNext()) &#123;</span><br><span class="line">        <span class="type">MethodMetadata</span> <span class="variable">methodMetadata</span> <span class="operator">=</span> (MethodMetadata)var18.next();</span><br><span class="line">        configClass.addBeanMethod(<span class="keyword">new</span> <span class="title class_">BeanMethod</span>(methodMetadata, configClass));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Process default methods on interfaces</span></span><br><span class="line">    <span class="built_in">this</span>.processInterfaces(configClass, sourceClass);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Process superclass, if any</span></span><br><span class="line">    <span class="keyword">if</span> (sourceClass.getMetadata().hasSuperClass()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">superclass</span> <span class="operator">=</span> sourceClass.getMetadata().getSuperClassName();</span><br><span class="line">        <span class="keyword">if</span> (superclass != <span class="literal">null</span> &amp;&amp; !superclass.startsWith(<span class="string">&quot;java&quot;</span>) &amp;&amp; !<span class="built_in">this</span>.knownSuperclasses.containsKey(superclass)) &#123;</span><br><span class="line">            <span class="built_in">this</span>.knownSuperclasses.put(superclass, configClass);</span><br><span class="line">            <span class="comment">// Superclass found, return its annotation metadata and recurse</span></span><br><span class="line">            <span class="keyword">return</span> sourceClass.getSuperClass();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// No superclass -&gt; processing is complete</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>介绍上面标记的几个和自动配置相关的注解处理方法</p>
<h4 id="处理-ComponentScan注解"><a href="#处理-ComponentScan注解" class="headerlink" title="处理@ComponentScan注解"></a>处理@ComponentScan注解</h4><p>相关代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】处理@ComponentScan注解</span></span><br><span class="line">Set&lt;AnnotationAttributes&gt; componentScans = AnnotationConfigUtils.attributesForRepeatable(sourceClass.getMetadata(), ComponentScans.class, ComponentScan.class);</span><br><span class="line"><span class="comment">//没有@ComponentScan注解注解或条件注解不通过</span></span><br><span class="line"><span class="keyword">if</span> (!componentScans.isEmpty() &amp;&amp; !<span class="built_in">this</span>.conditionEvaluator.shouldSkip(sourceClass.getMetadata(), ConfigurationPhase.REGISTER_BEAN)) &#123;</span><br><span class="line">    <span class="type">Iterator</span> <span class="variable">var14</span> <span class="operator">=</span> componentScans.iterator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(var14.hasNext()) &#123;</span><br><span class="line">        <span class="type">AnnotationAttributes</span> <span class="variable">componentScan</span> <span class="operator">=</span> (AnnotationAttributes)var14.next();</span><br><span class="line">        <span class="comment">//执行扫描</span></span><br><span class="line">        Set&lt;BeanDefinitionHolder&gt; scannedBeanDefinitions = <span class="built_in">this</span>.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName());</span><br><span class="line">        <span class="type">Iterator</span> <span class="variable">var8</span> <span class="operator">=</span> scannedBeanDefinitions.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var8.hasNext()) &#123;</span><br><span class="line">            <span class="type">BeanDefinitionHolder</span> <span class="variable">holder</span> <span class="operator">=</span> (BeanDefinitionHolder)var8.next();</span><br><span class="line">            <span class="type">BeanDefinition</span> <span class="variable">bdCand</span> <span class="operator">=</span> holder.getBeanDefinition().getOriginatingBeanDefinition();</span><br><span class="line">            <span class="keyword">if</span> (bdCand == <span class="literal">null</span>) &#123;</span><br><span class="line">                bdCand = holder.getBeanDefinition();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//检查是否是配置类（有@configuration/@component注解），则递归查找关联类</span></span><br><span class="line">            <span class="comment">//关联类包括内部的@bean注解定义的bean或者@import注解引入的类</span></span><br><span class="line">            <span class="keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(bdCand, <span class="built_in">this</span>.metadataReaderFactory)) &#123;</span><br><span class="line">                <span class="built_in">this</span>.parse(bdCand.getBeanClassName(), holder.getBeanName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这部分代码会根据<code>@ComponentScan</code>注解扫描对应路径的bean，如果没有设置<code>basePackages</code>属性，那么默认为标记的类的路径，进入</p>
<p><code>this.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName());</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//解析@ComponentScan方法中主要就是对该注解的各个属性进行处理，最后再根据basePackages进行扫描</span></span><br><span class="line"><span class="keyword">public</span> Set&lt;BeanDefinitionHolder&gt; <span class="title function_">parse</span><span class="params">(AnnotationAttributes componentScan, <span class="keyword">final</span> String declaringClass)</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果basePackages属性为空则默认值为对应类的包路径</span></span><br><span class="line">    <span class="keyword">if</span> (basePackages.isEmpty()) &#123;</span><br><span class="line">        basePackages.add(ClassUtils.getPackageName(declaringClass));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//根据basePackages扫描类</span></span><br><span class="line">    <span class="keyword">return</span> scanner.doScan(StringUtils.toStringArray(basePackages));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为启动spring boot项目时启动类会进入到该方法，并且启动类中的<code>@ComponentScan</code>注解没有给<code>basePackages</code>属性赋值，所以在扫描时会扫描启动类路径下的包和类，接着进入<code>scanner.doScan(StringUtils.toStringArray(basePackages))</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//扫描启动类路径下的包和类</span></span><br><span class="line"><span class="keyword">protected</span> Set&lt;BeanDefinitionHolder&gt; <span class="title function_">doScan</span><span class="params">(String... basePackages)</span> &#123;</span><br><span class="line">    Assert.notEmpty(basePackages, <span class="string">&quot;At least one base package must be specified&quot;</span>);</span><br><span class="line">    <span class="comment">//用来返回的beanDefinitions集合</span></span><br><span class="line">    Set&lt;BeanDefinitionHolder&gt; beanDefinitions = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>();</span><br><span class="line">    String[] var3 = basePackages;</span><br><span class="line">    <span class="type">int</span> <span class="variable">var4</span> <span class="operator">=</span> basePackages.length;</span><br><span class="line">	<span class="comment">//遍历basePackages数组中的各个路径，由于是启动类，basePackages也只有一个元素：com.zcy.springbootmytest</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">var5</span> <span class="operator">=</span> <span class="number">0</span>; var5 &lt; var4; ++var5) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">basePackage</span> <span class="operator">=</span> var3[var5];</span><br><span class="line">        <span class="comment">//【1.1】从指定路径扫描bean，并加载bean</span></span><br><span class="line">        Set&lt;BeanDefinition&gt; candidates = <span class="built_in">this</span>.findCandidateComponents(basePackage);</span><br><span class="line">        <span class="type">Iterator</span> <span class="variable">var8</span> <span class="operator">=</span> candidates.iterator();</span><br><span class="line">		<span class="comment">//遍历加载到的bean</span></span><br><span class="line">        <span class="keyword">while</span>(var8.hasNext()) &#123;</span><br><span class="line">            <span class="type">BeanDefinition</span> <span class="variable">candidate</span> <span class="operator">=</span> (BeanDefinition)var8.next();</span><br><span class="line">            <span class="type">ScopeMetadata</span> <span class="variable">scopeMetadata</span> <span class="operator">=</span> <span class="built_in">this</span>.scopeMetadataResolver.resolveScopeMetadata(candidate);</span><br><span class="line">            candidate.setScope(scopeMetadata.getScopeName());</span><br><span class="line">            <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> <span class="built_in">this</span>.beanNameGenerator.generateBeanName(candidate, <span class="built_in">this</span>.registry);</span><br><span class="line">            <span class="keyword">if</span> (candidate <span class="keyword">instanceof</span> AbstractBeanDefinition) &#123;</span><br><span class="line">                <span class="built_in">this</span>.postProcessBeanDefinition((AbstractBeanDefinition)candidate, beanName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (candidate <span class="keyword">instanceof</span> AnnotatedBeanDefinition) &#123;</span><br><span class="line">                AnnotationConfigUtils.processCommonDefinitionAnnotations((AnnotatedBeanDefinition)candidate);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.checkCandidate(beanName, candidate)) &#123;</span><br><span class="line">                <span class="type">BeanDefinitionHolder</span> <span class="variable">definitionHolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionHolder</span>(candidate, beanName);</span><br><span class="line">                definitionHolder = AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, <span class="built_in">this</span>.registry);</span><br><span class="line">                <span class="comment">//将bean装载到beanDefinitions中</span></span><br><span class="line">                beanDefinitions.add(definitionHolder);</span><br><span class="line">                <span class="comment">//【1.2】将bean注册到ioc容器中</span></span><br><span class="line">                <span class="built_in">this</span>.registerBeanDefinition(definitionHolder, <span class="built_in">this</span>.registry);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> beanDefinitions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="从指定目录扫描bean"><a href="#从指定目录扫描bean" class="headerlink" title="从指定目录扫描bean"></a>从指定目录扫描bean</h5><p>进入<code>this.findCandidateComponents(basePackage)</code>方法，该方法拼接了一个扫描路径，然后根据扫描路径匹配全部的类，在之后对扫描到的类进行排查，看是否有<code>@Component</code>注解，如果有，则将其封装成<code>BeanDefinition</code>，最终将封装好的BeanDefinition返回，具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这里会调用的是this.scanCandidateComponents(basePackage)方法</span></span><br><span class="line"><span class="keyword">public</span> Set&lt;BeanDefinition&gt; <span class="title function_">findCandidateComponents</span><span class="params">(String basePackage)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.componentsIndex != <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.indexSupportsIncludeFilters() ? <span class="built_in">this</span>.addCandidateComponentsFromIndex(<span class="built_in">this</span>.componentsIndex, basePackage) : <span class="built_in">this</span>.scanCandidateComponents(basePackage);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//进入this.scanCandidateComponents(basePackage)方法</span></span><br><span class="line"><span class="keyword">private</span> Set&lt;BeanDefinition&gt; <span class="title function_">scanCandidateComponents</span><span class="params">(String basePackage)</span> &#123;</span><br><span class="line">    <span class="type">LinkedHashSet</span> <span class="variable">candidates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//拼接路径，结果为：classpath*:com/zcy/springbootmytest/**/*.class</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">packageSearchPath</span> <span class="operator">=</span> <span class="string">&quot;classpath*:&quot;</span> + <span class="built_in">this</span>.resolveBasePackage(basePackage) + <span class="string">&#x27;/&#x27;</span> + <span class="built_in">this</span>.resourcePattern;</span><br><span class="line">        <span class="comment">//根据路径扫描匹配所有类</span></span><br><span class="line">        Resource[] resources = <span class="built_in">this</span>.getResourcePatternResolver().getResources(packageSearchPath);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">traceEnabled</span> <span class="operator">=</span> <span class="built_in">this</span>.logger.isTraceEnabled();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">debugEnabled</span> <span class="operator">=</span> <span class="built_in">this</span>.logger.isDebugEnabled();</span><br><span class="line">        Resource[] var7 = resources;</span><br><span class="line">        <span class="type">int</span> <span class="variable">var8</span> <span class="operator">=</span> resources.length;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//遍历扫描到的类</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">var9</span> <span class="operator">=</span> <span class="number">0</span>; var9 &lt; var8; ++var9) &#123;</span><br><span class="line">            <span class="type">Resource</span> <span class="variable">resource</span> <span class="operator">=</span> var7[var9];</span><br><span class="line">            <span class="keyword">if</span> (traceEnabled) &#123;</span><br><span class="line">                <span class="built_in">this</span>.logger.trace(<span class="string">&quot;Scanning &quot;</span> + resource);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (resource.isReadable()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">MetadataReader</span> <span class="variable">metadataReader</span> <span class="operator">=</span> <span class="built_in">this</span>.getMetadataReaderFactory().getMetadataReader(resource);</span><br><span class="line">                    <span class="comment">//判断该类是不是 @Component 注解标注的类，并且不是需要排除掉的类</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">this</span>.isCandidateComponent(metadataReader)) &#123;</span><br><span class="line">                        <span class="comment">//将该类封装成ScannedGenericBeanDefinition（BeanDefinition接口的实现类）类</span></span><br><span class="line">                        <span class="type">ScannedGenericBeanDefinition</span> <span class="variable">sbd</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScannedGenericBeanDefinition</span>(metadataReader);</span><br><span class="line">                        sbd.setSource(resource);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">this</span>.isCandidateComponent((AnnotatedBeanDefinition)sbd)) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (debugEnabled) &#123;</span><br><span class="line">                                <span class="built_in">this</span>.logger.debug(<span class="string">&quot;Identified candidate component class: &quot;</span> + resource);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            candidates.add(sbd);</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (debugEnabled) &#123;</span><br><span class="line">                            <span class="built_in">this</span>.logger.debug(<span class="string">&quot;Ignored because not a concrete top-level class: &quot;</span> + resource);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (traceEnabled) &#123;</span><br><span class="line">                        <span class="built_in">this</span>.logger.trace(<span class="string">&quot;Ignored because not matching any filter: &quot;</span> + resource);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var13) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionStoreException</span>(<span class="string">&quot;Failed to read candidate component class: &quot;</span> + resource, var13);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (traceEnabled) &#123;</span><br><span class="line">                <span class="built_in">this</span>.logger.trace(<span class="string">&quot;Ignored because not readable: &quot;</span> + resource);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//最终将封装好的BeanDefinition返回</span></span><br><span class="line">        <span class="keyword">return</span> candidates;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException var14) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionStoreException</span>(<span class="string">&quot;I/O failure during classpath scanning&quot;</span>, var14);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="将bean注册到ioc容器中"><a href="#将bean注册到ioc容器中" class="headerlink" title="将bean注册到ioc容器中"></a>将bean注册到ioc容器中</h5><p>可以看到虽然该方法最终返回了<code>beanDefinitions</code>集合，但其实<code>beanDefinition</code>已经被注入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将bean装载到beanDefinitions中</span></span><br><span class="line">beanDefinitions.add(definitionHolder);</span><br><span class="line"><span class="comment">//【1.2】将bean注册到ioc容器中</span></span><br><span class="line"><span class="built_in">this</span>.registerBeanDefinition(definitionHolder, <span class="built_in">this</span>.registry);</span><br></pre></td></tr></table></figure>

<h4 id="处理-Import注解"><a href="#处理-Import注解" class="headerlink" title="处理@Import注解"></a>处理@Import注解</h4><p>相关代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【2】处理@Import注解</span></span><br><span class="line"><span class="comment">//这里的处理是递归的</span></span><br><span class="line"><span class="comment">//SpringBoot项目中经常用的各种@Enable*** 注解基本都是封装的@Import</span></span><br><span class="line"><span class="built_in">this</span>.processImports(configClass, sourceClass, <span class="built_in">this</span>.getImports(sourceClass), filter, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<p>涉及到的方法有两个</p>
<ul>
<li>this.getImports方法：获取@import注解集合</li>
<li>processImports方法：</li>
</ul>
<h5 id="获取-import注解集合"><a href="#获取-import注解集合" class="headerlink" title="获取@import注解集合"></a>获取@import注解集合</h5><p>首先进入<code>getImports</code>方法中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Set&lt;ConfigurationClassParser.SourceClass&gt; getImports(ConfigurationClassParser.SourceClass sourceClass) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    Set&lt;ConfigurationClassParser.SourceClass&gt; imports = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>();</span><br><span class="line">    Set&lt;ConfigurationClassParser.SourceClass&gt; visited = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>();</span><br><span class="line">    <span class="built_in">this</span>.collectImports(sourceClass, imports, visited);</span><br><span class="line">    <span class="keyword">return</span> imports;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//进入collectImports方法</span></span><br><span class="line"><span class="comment">//这个方法是一个递归方法，直到解析到@import注解或者没有注解为止</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">collectImports</span><span class="params">(ConfigurationClassParser.SourceClass sourceClass, Set&lt;ConfigurationClassParser.SourceClass&gt; imports, Set&lt;ConfigurationClassParser.SourceClass&gt; visited)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (visited.add(sourceClass)) &#123;</span><br><span class="line">        <span class="comment">//取出当前注解</span></span><br><span class="line">        <span class="type">Iterator</span> <span class="variable">var4</span> <span class="operator">=</span> sourceClass.getAnnotations().iterator();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//遍历当前注解</span></span><br><span class="line">        <span class="keyword">while</span>(var4.hasNext()) &#123;</span><br><span class="line">            ConfigurationClassParser.<span class="type">SourceClass</span> <span class="variable">annotation</span> <span class="operator">=</span> (ConfigurationClassParser.SourceClass)var4.next();</span><br><span class="line">            <span class="type">String</span> <span class="variable">annName</span> <span class="operator">=</span> annotation.getMetadata().getClassName();</span><br><span class="line">            <span class="comment">//如果当前注解不是@import继续遍历包含的注解，否则直接跳出递归将注解加入到imports中</span></span><br><span class="line">            <span class="keyword">if</span> (!annName.equals(Import.class.getName())) &#123;</span><br><span class="line">                <span class="built_in">this</span>.collectImports(annotation, imports, visited);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//最终将@import注解返回</span></span><br><span class="line">        imports.addAll(sourceClass.getAnnotationAttributes(Import.class.getName(), <span class="string">&quot;value&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="引入的类加入到对应集合"><a href="#引入的类加入到对应集合" class="headerlink" title="引入的类加入到对应集合"></a>引入的类加入到对应集合</h5><p>进入<code>processImports</code>方法中，上一个方法已经解析出了该类的注解并传入到了本方法中，本方法先判断解析的注解是否为空，如果为空直接退出，若不为空则对注解进行遍历，启动类上注解引入的两个类分别为<code>AutoConfigurationImportSelector.class</code>和<code>AutoConfigurationPackages.Registrar.class</code>，这两个类分别是ImportSelector和ImportBeanDefinitionRegistrar的子类，本方法会对这两个类分别进行处理，处理的过程就是将这两个类加入到对应的集合中，集合会在注解解析完之后分别进行执行，具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processImports</span><span class="params">(ConfigurationClass configClass, ConfigurationClassParser.SourceClass currentSourceClass, Collection&lt;ConfigurationClassParser.SourceClass&gt; importCandidates, Predicate&lt;String&gt; exclusionFilter, <span class="type">boolean</span> checkForCircularImports)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!importCandidates.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (checkForCircularImports &amp;&amp; <span class="built_in">this</span>.isChainedImportOnStack(configClass)) &#123;</span><br><span class="line">            <span class="built_in">this</span>.problemReporter.error(<span class="keyword">new</span> <span class="title class_">ConfigurationClassParser</span>.CircularImportProblem(configClass, <span class="built_in">this</span>.importStack));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.importStack.push(configClass);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Iterator</span> <span class="variable">var6</span> <span class="operator">=</span> importCandidates.iterator();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span>(var6.hasNext()) &#123;</span><br><span class="line">                    <span class="comment">//遍历@import注解引入的类</span></span><br><span class="line">                    ConfigurationClassParser.<span class="type">SourceClass</span> <span class="variable">candidate</span> <span class="operator">=</span> (ConfigurationClassParser.SourceClass)var6.next();</span><br><span class="line">                    Class candidateClass;</span><br><span class="line">                    <span class="comment">//这里判断是否引入的是ImportSelector</span></span><br><span class="line">                    <span class="keyword">if</span> (candidate.isAssignable(ImportSelector.class)) &#123;</span><br><span class="line">                        <span class="comment">//加载引入类</span></span><br><span class="line">                        candidateClass = candidate.loadClass();</span><br><span class="line">                        <span class="comment">//判断是否排除</span></span><br><span class="line">                        <span class="type">ImportSelector</span> <span class="variable">selector</span> <span class="operator">=</span> (ImportSelector)ParserStrategyUtils.instantiateClass(candidateClass, ImportSelector.class, <span class="built_in">this</span>.environment, <span class="built_in">this</span>.resourceLoader, <span class="built_in">this</span>.registry);</span><br><span class="line">                        Predicate&lt;String&gt; selectorFilter = selector.getExclusionFilter();</span><br><span class="line">                        <span class="keyword">if</span> (selectorFilter != <span class="literal">null</span>) &#123;</span><br><span class="line">                            exclusionFilter = exclusionFilter.or(selectorFilter);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//如果是DeferredImportSelector则进入</span></span><br><span class="line">                        <span class="keyword">if</span> (selector <span class="keyword">instanceof</span> DeferredImportSelector) &#123;</span><br><span class="line">                            <span class="comment">//这个方法主要是将AutoConfigurationImportSelector加入到了</span></span><br><span class="line">                            <span class="comment">//deferredImportSelectors中</span></span><br><span class="line">                            <span class="built_in">this</span>.deferredImportSelectorHandler.handle(configClass, (DeferredImportSelector)selector);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            String[] importClassNames = selector.selectImports(currentSourceClass.getMetadata());</span><br><span class="line">                            Collection&lt;ConfigurationClassParser.SourceClass&gt; importSourceClasses = <span class="built_in">this</span>.asSourceClasses(importClassNames, exclusionFilter);</span><br><span class="line">                            <span class="built_in">this</span>.processImports(configClass, currentSourceClass, importSourceClasses, exclusionFilter, <span class="literal">false</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//这里判断引入的是否是ImportBeanDefinitionRegistrar</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (candidate.isAssignable(ImportBeanDefinitionRegistrar.class)) &#123;</span><br><span class="line">                        candidateClass = candidate.loadClass();</span><br><span class="line">                        <span class="type">ImportBeanDefinitionRegistrar</span> <span class="variable">registrar</span> <span class="operator">=</span> (ImportBeanDefinitionRegistrar)ParserStrategyUtils.instantiateClass(candidateClass, ImportBeanDefinitionRegistrar.class, <span class="built_in">this</span>.environment, <span class="built_in">this</span>.resourceLoader, <span class="built_in">this</span>.registry);</span><br><span class="line">                        <span class="comment">//加入到importBeanDefinitionRegistrars中</span></span><br><span class="line">                        configClass.addImportBeanDefinitionRegistrar(registrar, currentSourceClass.getMetadata());</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       	<span class="comment">//其他类会进入这里，比如配置引入的类，后面会说明</span></span><br><span class="line">                        <span class="comment">//加入到configurationClasses中</span></span><br><span class="line">                        <span class="built_in">this</span>.importStack.registerImport(currentSourceClass.getMetadata(), candidate.getMetadata().getClassName());</span><br><span class="line">                        <span class="built_in">this</span>.processConfigurationClass(candidate.asConfigClass(configClass), exclusionFilter);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (BeanDefinitionStoreException var17) &#123;</span><br><span class="line">                <span class="keyword">throw</span> var17;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var18) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionStoreException</span>(<span class="string">&quot;Failed to process import candidates for configuration class [&quot;</span> + configClass.getMetadata().getClassName() + <span class="string">&quot;]&quot;</span>, var18);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.importStack.pop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>到这里注解的解析和启动类所在目录下的类都已经成功引入了，接下来进行的就是对@import引入的两个类进行执行的过程</p>
<h4 id="加载默认配置"><a href="#加载默认配置" class="headerlink" title="加载默认配置"></a>加载默认配置</h4><p>上面两个步骤都是<code>parse</code>方法内部的<code>parse</code>方法里的，在执行完内部<code>parse</code>会执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【3】加载默认的配置---》（对springboot项目来说这里就是自动装配的入口了）</span></span><br><span class="line"><span class="built_in">this</span>.deferredImportSelectorHandler.process();</span><br></pre></td></tr></table></figure>

<p>由于上面两个方法已经将<code>AutoConfigurationImportSelector</code>加入到<code>deferredImportSelectorHandler</code>中，这里会对其进行执行，也就是引入自动配置类集合，进入该方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//拿到上一步deferredImportSelectors存储的DefererdImportSelectorHolder对象</span></span><br><span class="line">    <span class="comment">//其内部封装了AutoConfigurationImportSelector.class类</span></span><br><span class="line">    List&lt;ConfigurationClassParser.DeferredImportSelectorHolder&gt; deferredImports = <span class="built_in">this</span>.deferredImportSelectors;</span><br><span class="line">    <span class="built_in">this</span>.deferredImportSelectors = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (deferredImports != <span class="literal">null</span>) &#123;</span><br><span class="line">            ConfigurationClassParser.<span class="type">DeferredImportSelectorGroupingHandler</span> <span class="variable">handler</span> <span class="operator">=</span> ConfigurationClassParser.<span class="built_in">this</span>.<span class="keyword">new</span> <span class="title class_">DeferredImportSelectorGroupingHandler</span>();</span><br><span class="line">            deferredImports.sort(ConfigurationClassParser.DEFERRED_IMPORT_COMPARATOR);</span><br><span class="line">            <span class="comment">//先把DefererdImportSelectorHolder对象注册到ioc容器</span></span><br><span class="line">            deferredImports.forEach(handler::register);</span><br><span class="line">            <span class="comment">//自动配置的核心</span></span><br><span class="line">            handler.processGroupImports();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.deferredImportSelectors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//进入handler.processGroupImports()方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processGroupImports</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Iterator</span> <span class="variable">var1</span> <span class="operator">=</span> <span class="built_in">this</span>.groupings.values().iterator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(var1.hasNext()) &#123;</span><br><span class="line">        ConfigurationClassParser.<span class="type">DeferredImportSelectorGrouping</span> <span class="variable">grouping</span> <span class="operator">=</span> (ConfigurationClassParser.DeferredImportSelectorGrouping)var1.next();</span><br><span class="line">        Predicate&lt;String&gt; exclusionFilter = grouping.getCandidateFilter();</span><br><span class="line">        <span class="comment">//grouping.getImports()方法就是获取自动配置类目录的方法</span></span><br><span class="line">        grouping.getImports().forEach((entry) -&gt; &#123;</span><br><span class="line">            <span class="comment">//获取配置类信息后，使用forEach进行遍历</span></span><br><span class="line">            <span class="type">ConfigurationClass</span> <span class="variable">configurationClass</span> <span class="operator">=</span> (ConfigurationClass)<span class="built_in">this</span>.configurationClasses.get(entry.getMetadata());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//方法其实已经前面【2.2】用过了</span></span><br><span class="line">                <span class="comment">//就是在解析import注解时引入ImportSelector和Register类的那个方法</span></span><br><span class="line">                ConfigurationClassParser.<span class="built_in">this</span>.processImports(configurationClass, ConfigurationClassParser.<span class="built_in">this</span>.asSourceClass(configurationClass, exclusionFilter), Collections.singleton(ConfigurationClassParser.<span class="built_in">this</span>.asSourceClass(entry.getImportClassName(), exclusionFilter)), exclusionFilter, <span class="literal">false</span>);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">catch</span> (BeanDefinitionStoreException var5) &#123;</span><br><span class="line">                <span class="keyword">throw</span> var5;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var6) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionStoreException</span>(<span class="string">&quot;Failed to process import candidates for configuration class [&quot;</span> + configurationClass.getMetadata().getClassName() + <span class="string">&quot;]&quot;</span>, var6);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>grouping.getImports()</code>方法debug结果：</p>
<p><img src="/../../../../images/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/image-20211210223233852-16391467563871.png" alt="image-20211210223233852"></p>
<p>进入<code>grouping.getImports()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Iterable&lt;Entry&gt; <span class="title function_">getImports</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Iterator</span> <span class="variable">var1</span> <span class="operator">=</span> <span class="built_in">this</span>.deferredImports.iterator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(var1.hasNext()) &#123;</span><br><span class="line">        ConfigurationClassParser.<span class="type">DeferredImportSelectorHolder</span> <span class="variable">deferredImport</span> <span class="operator">=</span> (ConfigurationClassParser.DeferredImportSelectorHolder)var1.next();</span><br><span class="line">        <span class="built_in">this</span>.group.process(deferredImport.getConfigurationClass().getMetadata(), deferredImport.getImportSelector());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.group.selectImports();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法其实就是第二篇中的查看导入的<code>AutoConfigurationImportSelector.class</code>类的入口方法，当时的类调用图如下：</p>
<p><img src="/../../../../images/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/image-20211210224057328.png" alt="image-20211210224057328"></p>
<p>红色框出的就是当前方法所在的位置。到这里就已经和之前第二篇分析的自动配置执行连接起来了，此处不再赘述。</p>
<p>最后在拿到spring.factories文件中的自动配置类后会调用<code>ConfigurationClassParser.this.processImports</code>方法，这个方法在之前解析<code>@import</code>注解时就已经使用过（其实在这部分用的方法大多上面都已经介绍过）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processImports</span><span class="params">(ConfigurationClass configClass, ConfigurationClassParser.SourceClass currentSourceClass, Collection&lt;ConfigurationClassParser.SourceClass&gt; importCandidates, Predicate&lt;String&gt; exclusionFilter, <span class="type">boolean</span> checkForCircularImports)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!importCandidates.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (checkForCircularImports &amp;&amp; <span class="built_in">this</span>.isChainedImportOnStack(configClass)) &#123;</span><br><span class="line">            <span class="built_in">this</span>.problemReporter.error(<span class="keyword">new</span> <span class="title class_">ConfigurationClassParser</span>.CircularImportProblem(configClass, <span class="built_in">this</span>.importStack));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.importStack.push(configClass);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Iterator</span> <span class="variable">var6</span> <span class="operator">=</span> importCandidates.iterator();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span>(var6.hasNext()) &#123;</span><br><span class="line">                    ConfigurationClassParser.<span class="type">SourceClass</span> <span class="variable">candidate</span> <span class="operator">=</span> (ConfigurationClassParser.SourceClass)var6.next();</span><br><span class="line">                    Class candidateClass;</span><br><span class="line">                    <span class="keyword">if</span> (candidate.isAssignable(ImportSelector.class)) &#123;</span><br><span class="line">                        <span class="comment">//处理引入的ImportSelector</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (candidate.isAssignable(ImportBeanDefinitionRegistrar.class)) &#123;</span><br><span class="line">                        <span class="comment">//处理引入的1Registrar</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//此时会进入这里</span></span><br><span class="line">                        <span class="comment">//这个方法会将类添加到一个imports集合中</span></span><br><span class="line">                        <span class="comment">//this.imports.add(importedClass, importingClass);</span></span><br><span class="line">                        <span class="built_in">this</span>.importStack.registerImport(currentSourceClass.getMetadata(), candidate.getMetadata().getClassName());</span><br><span class="line">                        <span class="comment">//这个方法主要用来条件评估，然后将符合条件的自动配置类加入到configurationClasses中</span></span><br><span class="line">                        <span class="comment">//加入该集合的类会在（2）统一引入</span></span><br><span class="line">                        <span class="built_in">this</span>.processConfigurationClass(candidate.asConfigClass(configClass), exclusionFilter);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (BeanDefinitionStoreException var17) &#123;</span><br><span class="line">                <span class="keyword">throw</span> var17;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var18) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionStoreException</span>(<span class="string">&quot;Failed to process import candidates for configuration class [&quot;</span> + configClass.getMetadata().getClassName() + <span class="string">&quot;]&quot;</span>, var18);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.importStack.pop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">///进入this.processConfigurationClass(candidate.asConfigClass(configClass), exclusionFilter)方法</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">processConfigurationClass</span><span class="params">(ConfigurationClass configClass, Predicate&lt;String&gt; filter)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//根据条件注解判断是否需要跳过</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.conditionEvaluator.shouldSkip(configClass.getMetadata(), ConfigurationPhase.PARSE_CONFIGURATION)) &#123;</span><br><span class="line">        <span class="type">ConfigurationClass</span> <span class="variable">existingClass</span> <span class="operator">=</span> (ConfigurationClass)<span class="built_in">this</span>.configurationClasses.get(configClass);</span><br><span class="line">        <span class="comment">//判断配置类是否已经引入</span></span><br><span class="line">        <span class="keyword">if</span> (existingClass != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (configClass.isImported()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (existingClass.isImported()) &#123;</span><br><span class="line">                    existingClass.mergeImportedBy(configClass);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">this</span>.configurationClasses.remove(configClass);</span><br><span class="line">            <span class="built_in">this</span>.knownSuperclasses.values().removeIf(configClass::equals);</span><br><span class="line">        &#125;</span><br><span class="line">		</span><br><span class="line">        <span class="comment">//获取配置类</span></span><br><span class="line">        ConfigurationClassParser.<span class="type">SourceClass</span> <span class="variable">sourceClass</span> <span class="operator">=</span> <span class="built_in">this</span>.asSourceClass(configClass, filter);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">//又是这个方法，</span></span><br><span class="line">            <span class="comment">//这里主要是因为配置类也会有内部的bean、内部类等需要进行解析</span></span><br><span class="line">            sourceClass = <span class="built_in">this</span>.doProcessConfigurationClass(configClass, sourceClass, filter);</span><br><span class="line">        &#125; <span class="keyword">while</span>(sourceClass != <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加入到configurationClasses中</span></span><br><span class="line">        <span class="built_in">this</span>.configurationClasses.put(configClass, configClass);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果就是，被引入的那些类都被加入到了<code>configurationClasses</code>中</p>
<h3 id="loadBeanDefinitions方法"><a href="#loadBeanDefinitions方法" class="headerlink" title="loadBeanDefinitions方法"></a><code>loadBeanDefinitions</code>方法</h3><p>上面的一系列过程通过递归等操作，将需要引入的那些类根据不同的类型分别加入到了不同集合中</p>
<ul>
<li><code>deferredImportSelectors</code>：<code>ImportSelector</code>类型，例如<code>AutoConfigurationImportSelector</code>类</li>
<li><code>importBeanDefinitionRegistrars</code>：<code>ImportBeanDefinitionRegistrar</code>类型，例如<code>AutoConfigurationPackages.Registrar</code>类</li>
<li><code>configurationClasses</code>：其他类型，例如引入的配置类、自己包中定义的类</li>
<li><code>beanMethods</code>：类中的<code>@bean</code>注解引入的bean</li>
</ul>
<p>这一部分就是将上面的这些类和相关类注册进ioc容器中，注意本方法的参数在前面通过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;ConfigurationClass&gt; configClasses = new LinkedHashSet(parser.getConfigurationClasses());</span><br></pre></td></tr></table></figure>

<p>获取到了，所以<code>configurationModel</code>就是<code>configurationClasses</code>集合的值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loadBeanDefinitions</span><span class="params">(Set&lt;ConfigurationClass&gt; configurationModel)</span> &#123;</span><br><span class="line">    ConfigurationClassBeanDefinitionReader.<span class="type">TrackedConditionEvaluator</span> <span class="variable">trackedConditionEvaluator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfigurationClassBeanDefinitionReader</span>.TrackedConditionEvaluator();</span><br><span class="line">    <span class="type">Iterator</span> <span class="variable">var3</span> <span class="operator">=</span> configurationModel.iterator();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//遍历configurationModel</span></span><br><span class="line">    <span class="keyword">while</span>(var3.hasNext()) &#123;</span><br><span class="line">        <span class="type">ConfigurationClass</span> <span class="variable">configClass</span> <span class="operator">=</span> (ConfigurationClass)var3.next();</span><br><span class="line">        <span class="comment">//将集合中的类注册到ioc容器</span></span><br><span class="line">        <span class="built_in">this</span>.loadBeanDefinitionsForConfigurationClass(configClass, trackedConditionEvaluator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//进入this.loadBeanDefinitionsForConfigurationClass(configClass, trackedConditionEvaluator)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loadBeanDefinitionsForConfigurationClass</span><span class="params">(ConfigurationClass configClass, ConfigurationClassBeanDefinitionReader.TrackedConditionEvaluator trackedConditionEvaluator)</span> &#123;</span><br><span class="line">    <span class="comment">//根据条件注解判断是否需要跳过</span></span><br><span class="line">    <span class="keyword">if</span> (trackedConditionEvaluator.shouldSkip(configClass)) &#123;</span><br><span class="line">        <span class="comment">//获取beanName</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> configClass.getBeanName();</span><br><span class="line">        <span class="comment">//有beanName而且ioc中不包含</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasLength(beanName) &amp;&amp; <span class="built_in">this</span>.registry.containsBeanDefinition(beanName)) &#123;</span><br><span class="line">            <span class="built_in">this</span>.registry.removeBeanDefinition(beanName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//移除bean</span></span><br><span class="line">        <span class="built_in">this</span>.importRegistry.removeImportingClass(configClass.getMetadata().getClassName());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//是被引入的，则先将该配置类加入到ioc容器中</span></span><br><span class="line">        <span class="keyword">if</span> (configClass.isImported()) &#123;</span><br><span class="line">            <span class="comment">//里面应该是覆盖原本的bean</span></span><br><span class="line">            <span class="built_in">this</span>.registerBeanDefinitionForImportedConfigurationClass(configClass);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Iterator</span> <span class="variable">var3</span> <span class="operator">=</span> configClass.getBeanMethods().iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var3.hasNext()) &#123;</span><br><span class="line">            <span class="type">BeanMethod</span> <span class="variable">beanMethod</span> <span class="operator">=</span> (BeanMethod)var3.next();</span><br><span class="line">            <span class="comment">//【1】注册beanMethods</span></span><br><span class="line">            <span class="built_in">this</span>.loadBeanDefinitionsForBeanMethod(beanMethod);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】注册</span></span><br><span class="line">        <span class="built_in">this</span>.loadBeanDefinitionsFromImportedResources(configClass.getImportedResources());</span><br><span class="line">        <span class="comment">//【3】注册Registrar</span></span><br><span class="line">        <span class="built_in">this</span>.loadBeanDefinitionsFromRegistrars(configClass.getImportBeanDefinitionRegistrars());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="注册beanMethods"><a href="#注册beanMethods" class="headerlink" title="注册beanMethods"></a>注册beanMethods</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loadBeanDefinitionsForBeanMethod</span><span class="params">(BeanMethod beanMethod)</span> &#123;</span><br><span class="line">    <span class="type">ConfigurationClass</span> <span class="variable">configClass</span> <span class="operator">=</span> beanMethod.getConfigurationClass();</span><br><span class="line">    <span class="comment">//获取方法名，bean的name会根据方法名设置</span></span><br><span class="line">    <span class="type">MethodMetadata</span> <span class="variable">metadata</span> <span class="operator">=</span> beanMethod.getMetadata();</span><br><span class="line">    <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> metadata.getMethodName();</span><br><span class="line">    <span class="comment">//根据条件注解判断是否需要跳过</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.conditionEvaluator.shouldSkip(metadata, ConfigurationPhase.REGISTER_BEAN)) &#123;</span><br><span class="line">        configClass.skippedBeanMethods.add(methodName);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!configClass.skippedBeanMethods.contains(methodName)) &#123; <span class="comment">//还没有注册</span></span><br><span class="line">        <span class="comment">//获取注解属性</span></span><br><span class="line">        <span class="type">AnnotationAttributes</span> <span class="variable">bean</span> <span class="operator">=</span> AnnotationConfigUtils.attributesFor(metadata, Bean.class);</span><br><span class="line">        Assert.state(bean != <span class="literal">null</span>, <span class="string">&quot;No @Bean annotation attributes&quot;</span>);</span><br><span class="line">        <span class="comment">//获取name属性，没有设置则为空集合</span></span><br><span class="line">        List&lt;String&gt; names = <span class="keyword">new</span> <span class="title class_">ArrayList</span>(Arrays.asList(bean.getStringArray(<span class="string">&quot;name&quot;</span>)));</span><br><span class="line">        <span class="comment">//如果names不为空则以name作为beanName，否则使用方法名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> !names.isEmpty() ? (String)names.remove(<span class="number">0</span>) : methodName;</span><br><span class="line">        <span class="type">Iterator</span> <span class="variable">var8</span> <span class="operator">=</span> names.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//对每个names都作为key进行注册别名</span></span><br><span class="line">        <span class="keyword">while</span>(var8.hasNext()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">alias</span> <span class="operator">=</span> (String)var8.next();</span><br><span class="line">            <span class="built_in">this</span>.registry.registerAlias(beanName, alias);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//检查名字是否存在，有就报错</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.isOverriddenByExistingDefinition(beanMethod, beanName)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (beanName.equals(beanMethod.getConfigurationClass().getBeanName())) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionStoreException</span>(beanMethod.getConfigurationClass().getResource().getDescription(), beanName, <span class="string">&quot;Bean name derived from @Bean method &#x27;&quot;</span> + beanMethod.getMetadata().getMethodName() + <span class="string">&quot;&#x27; clashes with bean name for containing configuration class; please make those names unique!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">//名字没重复</span></span><br><span class="line">            <span class="comment">//包装成beanDefinition</span></span><br><span class="line">            ConfigurationClassBeanDefinitionReader.<span class="type">ConfigurationClassBeanDefinition</span> <span class="variable">beanDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfigurationClassBeanDefinitionReader</span>.ConfigurationClassBeanDefinition(configClass, metadata);</span><br><span class="line">            beanDef.setSource(<span class="built_in">this</span>.sourceExtractor.extractSource(metadata, configClass.getResource()));</span><br><span class="line">            <span class="comment">//下面就是为beanDefinition赋一些值，不重要的直接掠过</span></span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//下面是对注解的解析，判断是否加了对应注解</span></span><br><span class="line"></span><br><span class="line">            beanDef.setAutowireMode(<span class="number">3</span>);</span><br><span class="line">            beanDef.setAttribute(RequiredAnnotationBeanPostProcessor.SKIP_REQUIRED_CHECK_ATTRIBUTE, Boolean.TRUE);</span><br><span class="line">            AnnotationConfigUtils.processCommonDefinitionAnnotations(beanDef, metadata);</span><br><span class="line">            <span class="comment">//处理@autowire注解</span></span><br><span class="line">            <span class="type">Autowire</span> <span class="variable">autowire</span> <span class="operator">=</span> (Autowire)bean.getEnum(<span class="string">&quot;autowire&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (autowire.isAutowire()) &#123;</span><br><span class="line">                beanDef.setAutowireMode(autowire.value());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//处理@autowireCandidate注解</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">autowireCandidate</span> <span class="operator">=</span> bean.getBoolean(<span class="string">&quot;autowireCandidate&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!autowireCandidate) &#123;</span><br><span class="line">                beanDef.setAutowireCandidate(<span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//处理@initMethod注解</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">initMethodName</span> <span class="operator">=</span> bean.getString(<span class="string">&quot;initMethod&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.hasText(initMethodName)) &#123;</span><br><span class="line">                <span class="comment">//设置初始化方法</span></span><br><span class="line">                beanDef.setInitMethodName(initMethodName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//处理@destroyMethod注解</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">destroyMethodName</span> <span class="operator">=</span> bean.getString(<span class="string">&quot;destroyMethod&quot;</span>);</span><br><span class="line">            <span class="comment">//设置销毁方法</span></span><br><span class="line">            beanDef.setDestroyMethodName(destroyMethodName);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//处理@Scope注解（代理模式）</span></span><br><span class="line">            <span class="type">ScopedProxyMode</span> <span class="variable">proxyMode</span> <span class="operator">=</span> ScopedProxyMode.NO;</span><br><span class="line">            <span class="type">AnnotationAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> AnnotationConfigUtils.attributesFor(metadata, Scope.class);</span><br><span class="line">            <span class="keyword">if</span> (attributes != <span class="literal">null</span>) &#123;</span><br><span class="line">                beanDef.setScope(attributes.getString(<span class="string">&quot;value&quot;</span>));</span><br><span class="line">                proxyMode = (ScopedProxyMode)attributes.getEnum(<span class="string">&quot;proxyMode&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (proxyMode == ScopedProxyMode.DEFAULT) &#123;</span><br><span class="line">                    proxyMode = ScopedProxyMode.NO;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">BeanDefinition</span> <span class="variable">beanDefToRegister</span> <span class="operator">=</span> beanDef;</span><br><span class="line">            <span class="comment">//如果代理模式不是no，则进行相应处理</span></span><br><span class="line">            <span class="keyword">if</span> (proxyMode != ScopedProxyMode.NO) &#123;</span><br><span class="line">                <span class="type">BeanDefinitionHolder</span> <span class="variable">proxyDef</span> <span class="operator">=</span> ScopedProxyCreator.createScopedProxy(<span class="keyword">new</span> <span class="title class_">BeanDefinitionHolder</span>(beanDef, beanName), <span class="built_in">this</span>.registry, proxyMode == ScopedProxyMode.TARGET_CLASS);</span><br><span class="line">                beanDefToRegister = <span class="keyword">new</span> <span class="title class_">ConfigurationClassBeanDefinitionReader</span>.ConfigurationClassBeanDefinition((RootBeanDefinition)proxyDef.getBeanDefinition(), configClass, metadata);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">                logger.trace(String.format(<span class="string">&quot;Registering bean definition for @Bean method %s.%s()&quot;</span>, configClass.getMetadata().getClassName(), beanName));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//这个方法就是将bean注册进ioc容器中</span></span><br><span class="line">            <span class="built_in">this</span>.registry.registerBeanDefinition(beanName, beanDefToRegister);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="注册ImportedResources"><a href="#注册ImportedResources" class="headerlink" title="注册ImportedResources"></a>注册ImportedResources</h4><p>这个方法应该是从配置文件中导入bean，由于项目中都是使用注解导入，这里重要性比较低，所以只做简单介绍，进入<code>this.loadBeanDefinitionsFromImportedResources(configClass.getImportedResources())</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loadBeanDefinitionsFromImportedResources</span><span class="params">(Map&lt;String, Class&lt;? extends BeanDefinitionReader&gt;&gt; importedResources)</span> &#123;</span><br><span class="line">    Map&lt;Class&lt;?&gt;, BeanDefinitionReader&gt; readerInstanceCache = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    importedResources.forEach((resource, readerClass) -&gt; &#123;</span><br><span class="line">        <span class="comment">//判断文件类型</span></span><br><span class="line">        <span class="keyword">if</span> (BeanDefinitionReader.class == readerClass) &#123;</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.endsWithIgnoreCase(resource, <span class="string">&quot;.groovy&quot;</span>)) &#123;</span><br><span class="line">                readerClass = GroovyBeanDefinitionReader.class;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                readerClass = XmlBeanDefinitionReader.class;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取读取器</span></span><br><span class="line">        <span class="type">BeanDefinitionReader</span> <span class="variable">reader</span> <span class="operator">=</span> (BeanDefinitionReader)readerInstanceCache.get(readerClass);</span><br><span class="line">        <span class="keyword">if</span> (reader == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                reader = (BeanDefinitionReader)readerClass.getConstructor(BeanDefinitionRegistry.class).newInstance(<span class="built_in">this</span>.registry);</span><br><span class="line">                <span class="keyword">if</span> (reader <span class="keyword">instanceof</span> AbstractBeanDefinitionReader) &#123;</span><br><span class="line">                    <span class="type">AbstractBeanDefinitionReader</span> <span class="variable">abdr</span> <span class="operator">=</span> (AbstractBeanDefinitionReader)reader;</span><br><span class="line">                    abdr.setResourceLoader(<span class="built_in">this</span>.resourceLoader);</span><br><span class="line">                    abdr.setEnvironment(<span class="built_in">this</span>.environment);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                readerInstanceCache.put(readerClass, reader);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var6) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Could not instantiate BeanDefinitionReader class [&quot;</span> + readerClass.getName() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//读取资源</span></span><br><span class="line">        reader.loadBeanDefinitions(resource);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="注册Registrar"><a href="#注册Registrar" class="headerlink" title="注册Registrar"></a>注册Registrar</h4><p>被加入到<code>ImportBeanDefinitionRegistrars</code>集合中的类会在这里被加载，默认调用每个<code>ImportBeanDefinitionRegistrars</code>的<code>registerBeanDefinitions</code>方法，具体实现由其类自己定义，下面只拿注册类上的<code>AutoConfigurationPackages.Registrar</code>举例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loadBeanDefinitionsFromRegistrars</span><span class="params">(Map&lt;ImportBeanDefinitionRegistrar, AnnotationMetadata&gt; registrars)</span> &#123;</span><br><span class="line">    registrars.forEach((registrar, metadata) -&gt; &#123;</span><br><span class="line">        registrar.registerBeanDefinitions(metadata, <span class="built_in">this</span>.registry, <span class="built_in">this</span>.importBeanNameGenerator);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这里调用每个registrar的registerBeanDefinitions方法，registerBeanDefinitions由其自己实现</span></span><br><span class="line"><span class="comment">//进入registrar.registerBeanDefinitions(metadata, this.registry, this.importBeanNameGenerator)</span></span><br><span class="line"><span class="comment">//ImportBeanDefinitionRegistrar类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ImportBeanDefinitionRegistrar</span> &#123;</span><br><span class="line">    <span class="comment">//调用了registerBeanDefinitions</span></span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry, BeanNameGenerator importBeanNameGenerator)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.registerBeanDefinitions(importingClassMetadata, registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//进入这里，AutoConfigurationPackages.Registrar.class是他的一个实现类</span></span><br><span class="line">    <span class="comment">//所以真正进入的是AutoConfigurationPackages.Registrar.class</span></span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//AutoConfigurationPackages.Registrar.class</span></span><br><span class="line"><span class="comment">//由于第二篇已经说过，这里只显示代码，不做过多解释</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Registrar</span> <span class="keyword">implements</span> <span class="title class_">ImportBeanDefinitionRegistrar</span>, DeterminableImports &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//进入到这个方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">        <span class="comment">//这个方法是向ioc中注册组件</span></span><br><span class="line">        register(registry, <span class="keyword">new</span> <span class="title class_">PackageImport</span>(metadata).getPackageName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Set&lt;Object&gt; <span class="title function_">determineImports</span><span class="params">(AnnotationMetadata metadata)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.singleton(<span class="keyword">new</span> <span class="title class_">PackageImport</span>(metadata));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//接着进入register方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(BeanDefinitionRegistry registry, String... packageNames)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (registry.containsBeanDefinition(BEAN)) &#123;</span><br><span class="line">        <span class="type">BeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> registry.getBeanDefinition(BEAN);</span><br><span class="line">        <span class="type">ConstructorArgumentValues</span> <span class="variable">constructorArguments</span> <span class="operator">=</span> beanDefinition.getConstructorArgumentValues();</span><br><span class="line">        constructorArguments.addIndexedArgumentValue(<span class="number">0</span>, addBasePackages(constructorArguments, packageNames));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">GenericBeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericBeanDefinition</span>();</span><br><span class="line">        beanDefinition.setBeanClass(BasePackages.class);</span><br><span class="line">        beanDefinition.getConstructorArgumentValues().addIndexedArgumentValue(<span class="number">0</span>, packageNames);</span><br><span class="line">        beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">        registry.registerBeanDefinition(BEAN, beanDefinition);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div><div class="article-licensing box"><div class="licensing-title"><p>Spring Boot 源码解析（四）run()方法执行流程</p><p><a href="http://example.com/2020/12/04/框架/Java/Spring Boot/SpringBoot源码解析（四）/">http://example.com/2020/12/04/框架/Java/Spring Boot/SpringBoot源码解析（四）/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>路由器</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2020-12-04</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2022-06-27</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">SpringBoot源码解析</a></div></article></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/01/18/%E6%A1%86%E6%9E%B6/Java/Spring%20Boot/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E4%BA%94%EF%BC%89/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Spring Boot 源码解析（五）bean注册顺序</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/10/15/%E6%A1%86%E6%9E%B6/Java/Spring%20Boot/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%89%EF%BC%89/"><span class="level-item">Spring Boot 源码解析（三）SpringApplication 初始化</span><i class="level-item fas fa-chevron-right"></i></a></div></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="路由器"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">路由器</p><p class="is-size-6 is-block">笔记</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>M78</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">143</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">32</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">30</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/zcy626727" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/zcy626727"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/C/"><span class="level-start"><span class="level-item">C#</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/Dart/"><span class="level-start"><span class="level-item">Dart</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/categories/Docker/"><span class="level-start"><span class="level-item">Docker</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/Elixir/"><span class="level-start"><span class="level-item">Elixir</span></span><span class="level-end"><span class="level-item tag">10</span></span></a><ul><li><a class="level is-mobile" href="/categories/Elixir/Phoenix/"><span class="level-start"><span class="level-item">Phoenix</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Go/"><span class="level-start"><span class="level-item">Go</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/categories/Java/"><span class="level-start"><span class="level-item">Java</span></span><span class="level-end"><span class="level-item tag">33</span></span></a><ul><li><a class="level is-mobile" href="/categories/Java/Hadoop/"><span class="level-start"><span class="level-item">Hadoop</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/Java/Quarkus/"><span class="level-start"><span class="level-item">Quarkus</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Java/Spring/"><span class="level-start"><span class="level-item">Spring</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/Java/Spring-Boot/"><span class="level-start"><span class="level-item">Spring Boot</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/categories/Java/Spring-MVC/"><span class="level-start"><span class="level-item">Spring MVC</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Java/%E8%AF%AD%E6%B3%95/"><span class="level-start"><span class="level-item">语法</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Kotlin/"><span class="level-start"><span class="level-item">Kotlin</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/categories/Kubernetes/"><span class="level-start"><span class="level-item">Kubernetes</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux/"><span class="level-start"><span class="level-item">Linux</span></span><span class="level-end"><span class="level-item tag">8</span></span></a><ul><li><a class="level is-mobile" href="/categories/Linux/Arch/"><span class="level-start"><span class="level-item">Arch</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux/Fedora/"><span class="level-start"><span class="level-item">Fedora</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux/Ubuntu/"><span class="level-start"><span class="level-item">Ubuntu</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Minio/"><span class="level-start"><span class="level-item">Minio</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/"><span class="level-start"><span class="level-item">Python</span></span><span class="level-end"><span class="level-item tag">9</span></span></a><ul><li><a class="level is-mobile" href="/categories/Python/Scrapy/"><span class="level-start"><span class="level-item">Scrapy</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Rust/"><span class="level-start"><span class="level-item">Rust</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/TypeScript/"><span class="level-start"><span class="level-item">TypeScript</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="level-start"><span class="level-item">数据库</span></span><span class="level-end"><span class="level-item tag">2</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/MongoDB/"><span class="level-start"><span class="level-item">MongoDB</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/"><span class="level-start"><span class="level-item">Redis</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"><span class="level-start"><span class="level-item">深度学习</span></span><span class="level-end"><span class="level-item tag">5</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/Transformers/"><span class="level-start"><span class="level-item">Transformers</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/pytorch/"><span class="level-start"><span class="level-item">pytorch</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/%E7%AE%97%E6%B3%95/"><span class="level-start"><span class="level-item">算法</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/"><span class="level-start"><span class="level-item">编程语言</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-10-18T16:00:00.000Z">2023-10-19</time></p><p class="title"><a href="/2023/10/19/%E6%A1%86%E6%9E%B6/Elixir/Phoenix/Controller/">Phoenix 控制器</a></p><p class="categories"><a href="/categories/Elixir/">Elixir</a> / <a href="/categories/Elixir/Phoenix/">Phoenix</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-10-17T16:00:00.000Z">2023-10-18</time></p><p class="title"><a href="/2023/10/18/%E8%AF%AD%E8%A8%80/Carbon/template/"> </a></p><p class="categories"><a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-10-17T16:00:00.000Z">2023-10-18</time></p><p class="title"><a href="/2023/10/18/%E8%AF%AD%E8%A8%80/PHP/template/"> </a></p><p class="categories"><a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-10-17T16:00:00.000Z">2023-10-18</time></p><p class="title"><a href="/2023/10/18/%E8%AF%AD%E8%A8%80/Python/%E5%87%BD%E6%95%B0/">函数</a></p><p class="categories"><a href="/categories/Python/">Python</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-10-17T16:00:00.000Z">2023-10-18</time></p><p class="title"><a href="/2023/10/18/%E8%AF%AD%E8%A8%80/Python/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/">异常处理</a></p><p class="categories"><a href="/categories/Python/">Python</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/10/"><span class="level-start"><span class="level-item">十月 2023</span></span><span class="level-end"><span class="level-item tag">88</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/06/"><span class="level-start"><span class="level-item">六月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/05/"><span class="level-start"><span class="level-item">五月 2023</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/04/"><span class="level-start"><span class="level-item">四月 2023</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/03/"><span class="level-start"><span class="level-item">三月 2023</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/01/"><span class="level-start"><span class="level-item">一月 2023</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/12/"><span class="level-start"><span class="level-item">十二月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/11/"><span class="level-start"><span class="level-item">十一月 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">十月 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/09/"><span class="level-start"><span class="level-item">九月 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">七月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">六月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">五月 2022</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">一月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/12/"><span class="level-start"><span class="level-item">十二月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">十二月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">八月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">三月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">二月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Arch/"><span class="tag">Arch</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker-%E5%91%BD%E4%BB%A4/"><span class="tag">Docker 命令</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Fedora/"><span class="tag">Fedora</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hadoop/"><span class="tag">Hadoop</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Kubernetes/"><span class="tag">Kubernetes</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Minio/"><span class="tag">Minio</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MongoDB/"><span class="tag">MongoDB</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Redis/"><span class="tag">Redis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/S3/"><span class="tag">S3</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SpringBootWeb%E6%A1%86%E6%9E%B6%E9%9B%86%E6%88%90/"><span class="tag">SpringBootWeb框架集成</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SpringBoot%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E6%88%90/"><span class="tag">SpringBoot数据库集成</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SpringBoot%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD/"><span class="tag">SpringBoot核心功能</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SpringBoot%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"><span class="tag">SpringBoot源码解析</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spring%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE/"><span class="tag">Spring数据访问</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spring%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD/"><span class="tag">Spring核心功能</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spring%E6%B3%A8%E8%A7%A3/"><span class="tag">Spring注解</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ubuntu/"><span class="tag">Ubuntu</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/fedora/"><span class="tag">fedora</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"><span class="tag">分布式文件系统</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8C%85%E7%AE%A1%E7%90%86%E5%99%A8/"><span class="tag">包管理器</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"><span class="tag">大数据</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B7%A5%E5%85%B7/"><span class="tag">工具</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%A1%86%E6%9E%B6/"><span class="tag">框架</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B5%8B%E8%AF%95/"><span class="tag">测试</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%88%AC%E8%99%AB/"><span class="tag">爬虫</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"><span class="tag">环境配置</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/"><span class="tag">编程语言</span><span class="tag">85</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%AF%AD%E6%B3%95/"><span class="tag">语法</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%83%A8%E7%BD%B2/"><span class="tag">部署</span><span class="tag">1</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/avatar.png" alt="路由器" height="28"></a><p class="is-size-7"><span>&copy; 2023 路由器</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>